<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>PAC Dimensionnement â€” Outil de dimensionnement PAC collectives</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta20/dist/css/tabler.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/dist/tabler-icons.min.css">
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<style>
:root{
  --mono:'DM Mono',monospace;
  --atlantic:#003366;
  --atlantic-light:#004488;
  --orange:#e8622a;
  --orange-hover:#f07830;
}
/* LAYOUT: two-panel app */
.app-layout{display:flex;min-height:calc(100vh - 102px)}
.panel-input{width:420px;flex-shrink:0;background:#fff;border-right:1px solid var(--tblr-border-color);overflow-y:auto}
.panel-results{flex:1;background:#f8fafc;overflow-y:auto;padding:24px}
@media(min-width:992px){
  .panel-input,.panel-results{height:calc(100vh - 102px)}
}
@media(max-width:991.98px){
  .app-layout{flex-direction:column}
  .panel-input{width:100%;border-right:none;border-bottom:1px solid var(--tblr-border-color)}
  .panel-results{padding:16px}
}
/* Scrollbar */
.panel-input::-webkit-scrollbar,.panel-results::-webkit-scrollbar{width:5px}
.panel-input::-webkit-scrollbar-thumb,.panel-results::-webkit-scrollbar-thumb{background:#d1d5db;border-radius:3px}
/* Section titles */
.section-head{font-size:.7rem;font-weight:700;text-transform:uppercase;letter-spacing:.12em;
  color:var(--atlantic);margin-bottom:.75rem;display:flex;align-items:center;gap:8px}
.section-head::before{content:'';display:block;width:3px;height:14px;border-radius:2px;background:var(--orange)}
/* Stat readout */
.stat-readout{background:#f1f5f9;border-radius:6px;padding:10px 12px;text-align:center}
.stat-readout .stat-label{font-size:.62rem;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:#94a3af}
.stat-readout .stat-value{font-family:var(--mono);font-size:1.15rem;font-weight:500;color:var(--atlantic);margin-top:2px}
.stat-readout .stat-value.teal{color:#0891b2}
/* Orange button */
.btn-atlantic{background:var(--orange);border-color:var(--orange);color:#fff;font-weight:700}
.btn-atlantic:hover{background:var(--orange-hover);border-color:var(--orange-hover);color:#fff;box-shadow:0 4px 12px rgba(232,98,42,.25)}
/* Selectgroup wider */
.form-selectgroup{width:100%}
.form-selectgroup-item{flex:1}
/* Solutions grid */
.solutions-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px;margin-bottom:24px}
.sol-card{transition:all .15s;cursor:pointer;position:relative}
.sol-card:hover{border-color:var(--orange);box-shadow:0 2px 12px rgba(0,0,0,.06)}
.sol-card.selected{border-color:var(--orange);box-shadow:0 0 0 1px var(--orange)}
.sol-card.selected::after{content:'SELECTIONNE';position:absolute;top:10px;right:10px;
  font-size:.58rem;font-weight:800;letter-spacing:.06em;padding:2px 8px;border-radius:4px;
  background:var(--orange);color:#fff}
/* Metrics in card */
.metric-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.metric-box{background:#f8fafc;border-radius:6px;padding:10px}
.metric-box .m-label{font-size:.62rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:#94a3af}
.metric-box .m-value{font-family:var(--mono);font-size:1rem;font-weight:500;color:#1a2332;margin-top:2px}
.metric-box .m-value .m-unit{font-size:.72rem;color:#94a3af;font-weight:400}
.metric-box .m-value.good{color:#16a34a}
.metric-box .m-value.warn{color:var(--orange)}
/* Detail tables */
.detail-card .card-header{padding:.75rem 1rem}
.detail-card .badge-bar{width:4px;height:16px;border-radius:2px;display:inline-block;margin-right:8px;vertical-align:middle}
.mono{font-family:var(--mono)!important}
.highlight{color:var(--orange)!important;font-weight:600!important}
/* Atlantic row in comparison */
.table .atlantic-row{background:rgba(232,98,42,.04)}
.table .atlantic-row td:first-child{border-left:3px solid var(--orange);padding-left:calc(.75rem - 3px)}
/* Chart */
.chart-box{width:100%;height:360px}
/* Legionella card */
.card-danger-accent{border-left:3px solid #dc2626}
/* Active tab override for dark navbar */
.navbar-dark .nav-link.active,.navbar-dark .nav-link.active:hover{color:#fff;opacity:1;
  border-bottom:2px solid var(--orange);padding-bottom:6px;margin-bottom:-8px}
.navbar-dark .nav-link{color:rgba(255,255,255,.6);font-weight:600;font-size:.82rem;transition:color .15s}
.navbar-dark .nav-link:hover{color:rgba(255,255,255,.85)}
.nav-dot{display:inline-block;width:7px;height:7px;border-radius:50%;margin-right:6px;vertical-align:middle}
/* Print hide */
@media print{.panel-input,.navbar{display:none!important}.panel-results{height:auto!important}}
/* Animation */
@keyframes fadeUp{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.fade-up{animation:fadeUp .25s ease-out both}
/* Placeholder */
.results-placeholder{display:flex;flex-direction:column;align-items:center;justify-content:center;
  min-height:400px;color:#94a3af;text-align:center;gap:16px}
.results-placeholder p{max-width:380px;line-height:1.7;font-size:.92rem}
</style>
</head>
<body class="theme-light">

<!-- ===== NAVBAR ===== -->
<header class="navbar navbar-expand-lg navbar-dark sticky-top" style="background:var(--atlantic)">
  <div class="container-fluid">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMenu" aria-expanded="false">
      <span class="navbar-toggler-icon"></span>
    </button>
    <a class="navbar-brand d-none-navbar-horizontal pe-0 pe-md-3" href="#">
      <svg viewBox="0 0 32 32" width="28" height="28" fill="none" class="me-2">
        <rect width="32" height="32" rx="7" fill="#e8622a"/>
        <path d="M8 23V9h3.5l4.5 8 4.5-8H24v14h-3.5V14l-4.5 8-4.5-8v9z" fill="#fff"/>
      </svg>
      <span>PAC Dimensionnement</span>
    </a>
    <small class="text-white opacity-50 d-none d-md-inline ms-2" style="font-size:.75rem">Outil de dimensionnement PAC collectives</small>
    <div class="collapse navbar-collapse" id="navMenu">
      <ul class="navbar-nav ms-auto" id="tabs">
        <li class="nav-item">
          <a class="nav-link active" href="#" data-mode="elec" onclick="switchMode('elec');return false">
            <span class="nav-dot" style="background:#4a9af5"></span>Chauffage 100% Elec
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#" data-mode="double" onclick="switchMode('double');return false">
            <span class="nav-dot" style="background:#0891b2"></span>Double Service
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#" data-mode="ecs" onclick="switchMode('ecs');return false">
            <span class="nav-dot" style="background:#16a34a"></span>ECS Seul
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#" data-mode="hybrid" onclick="switchMode('hybrid');return false">
            <span class="nav-dot" style="background:#e8622a"></span>Chauffage Hybride
          </a>
        </li>
      </ul>
    </div>
  </div>
</header>

<!-- ===== SUB-HEADER: context bar ===== -->
<div class="bg-white border-bottom py-2 px-3 d-flex align-items-center gap-2" style="font-size:.78rem">
  <i class="ti ti-info-circle text-muted"></i>
  <span class="text-muted">Methodologie : NF EN 12831 / EN 14825 / ADEME-COSTIC &mdash; Donnees certifiees Heat Pump Keymark</span>
</div>

<!-- ===== MAIN LAYOUT ===== -->
<div class="app-layout">

  <!-- ===== LEFT: INPUT PANEL ===== -->
  <div class="panel-input" id="panelLeft">

    <!-- LOCALISATION -->
    <div class="p-3 border-bottom">
      <div class="section-head">Localisation</div>
      <div class="mb-3">
        <label class="form-label" for="dept">Departement</label>
        <select class="form-select" id="dept" onchange="onDeptChange()"></select>
      </div>
      <div class="row g-3 mb-2">
        <div class="col-6">
          <label class="form-label" for="altitude">Altitude (m)</label>
          <input type="number" class="form-control" id="altitude" value="0" min="0" max="3000" step="50" placeholder="0" onchange="onLocationChange()">
        </div>
        <div class="col-6 d-flex align-items-end pb-1">
          <label class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="bordMer" onchange="onLocationChange()">
            <span class="form-check-label">Bord de mer</span>
          </label>
        </div>
      </div>
      <div class="row g-2 mt-2">
        <div class="col-4"><div class="stat-readout"><div class="stat-label">T base</div><div class="stat-value teal" id="rdTbase">&mdash;</div></div></div>
        <div class="col-4"><div class="stat-readout"><div class="stat-label">Zone</div><div class="stat-value" id="rdZone">&mdash;</div></div></div>
        <div class="col-4"><div class="stat-readout"><div class="stat-label">Climat</div><div class="stat-value" id="rdClimat">&mdash;</div></div></div>
      </div>
    </div>

    <!-- BATIMENT -->
    <div class="p-3 border-bottom">
      <div class="section-head">Batiment</div>
      <div class="mb-3">
        <label class="form-label" for="buildingType">Type de batiment</label>
        <select class="form-select" id="buildingType" onchange="onBuildingChange()"></select>
      </div>
      <div class="row g-3">
        <div class="col-6">
          <label class="form-label" for="surface">Surface (m&sup2;)</label>
          <input type="number" class="form-control" id="surface" value="1500" min="50" max="50000" step="50" onchange="onBuildingChange()">
        </div>
        <div class="col-6">
          <label class="form-label" for="tConsigne">T consigne (&deg;C)</label>
          <input type="number" class="form-control" id="tConsigne" value="19" min="15" max="25" step="1" onchange="onBuildingChange()">
        </div>
      </div>
      <div class="row g-2 mt-2">
        <div class="col-6"><div class="stat-readout"><div class="stat-label">Deperditions</div><div class="stat-value" id="rdDep">&mdash; <small class="text-muted" style="font-size:.7rem">kW</small></div></div></div>
        <div class="col-6"><div class="stat-readout"><div class="stat-label">Dp</div><div class="stat-value" id="rdDp">&mdash; <small class="text-muted" style="font-size:.7rem">W/K</small></div></div></div>
      </div>
    </div>

    <!-- PAC -->
    <div class="p-3 border-bottom" id="sectionPAC">
      <div class="section-head">Pompe a chaleur</div>
      <div class="mb-3">
        <label class="form-label">Gamme PAC</label>
        <div class="form-selectgroup w-100">
          <label class="form-selectgroup-item flex-fill">
            <input type="radio" name="gamme" value="effipac" class="form-selectgroup-input" checked onchange="onPACChange()">
            <div class="form-selectgroup-label d-flex align-items-center justify-content-center">Effipac <span class="badge bg-blue-lt ms-2">R32</span></div>
          </label>
          <label class="form-selectgroup-item flex-fill">
            <input type="radio" name="gamme" value="aptae" class="form-selectgroup-input" onchange="onPACChange()">
            <div class="form-selectgroup-label d-flex align-items-center justify-content-center">Aptae <span class="badge bg-green-lt ms-2">R290</span></div>
          </label>
        </div>
      </div>
      <div class="row g-3">
        <div class="col-6">
          <label class="form-label" for="tWater">T eau depart</label>
          <select class="form-select" id="tWater" onchange="onPACChange()">
            <option value="35">35&deg;C &mdash; plancher</option>
            <option value="45" selected>45&deg;C &mdash; rad. BT</option>
            <option value="55">55&deg;C &mdash; rad. HT</option>
          </select>
        </div>
        <div class="col-6">
          <label class="form-label" for="deltaT">&Delta;T</label>
          <select class="form-select" id="deltaT" onchange="onPACChange()">
            <option value="3">3 K</option>
            <option value="5" selected>5 K</option>
            <option value="8">8 K</option>
          </select>
        </div>
      </div>
    </div>

    <!-- ECS -->
    <div class="p-3 border-bottom" id="sectionECS" style="display:none">
      <div class="section-head">Eau Chaude Sanitaire</div>
      <div class="mb-3">
        <label class="form-label" for="ecsType">Type batiment ECS</label>
        <select class="form-select" id="ecsType" onchange="onECSChange()">
          <option value="logements" selected>Logements collectifs</option>
          <optgroup label="Tertiaire">
            <option value="hotel_affaire">Hotel affaire</option>
            <option value="hotel_tourisme">Hotel tourisme 3-4*</option>
            <option value="ehpad">EHPAD</option>
            <option value="hopital">Hopital</option>
            <option value="maison_retraite">Maison de retraite</option>
            <option value="residence_etudiante">Residence etudiante</option>
            <option value="restaurant_collectif">Restauration collective</option>
          </optgroup>
        </select>
      </div>
      <div id="ecsLogements">
        <div class="mb-3">
          <label class="form-label">Parc</label>
          <div class="form-selectgroup w-100">
            <label class="form-selectgroup-item flex-fill">
              <input type="radio" name="parc" value="social" class="form-selectgroup-input" checked onchange="onECSChange()">
              <div class="form-selectgroup-label d-flex align-items-center justify-content-center">Social</div>
            </label>
            <label class="form-selectgroup-item flex-fill">
              <input type="radio" name="parc" value="prive" class="form-selectgroup-input" onchange="onECSChange()">
              <div class="form-selectgroup-label d-flex align-items-center justify-content-center">Prive</div>
            </label>
          </div>
        </div>
        <table class="table table-sm table-borderless mb-0" id="ecsGrid">
          <thead>
            <tr class="text-muted" style="font-size:.7rem">
              <th>Type</th>
              <th class="text-center">Equiv. LS</th>
              <th class="text-center" style="width:90px">Nombre</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="align-middle">T1 / Studio</td>
              <td class="align-middle text-center mono text-muted" id="eqT1">0.6</td>
              <td><input type="number" class="form-control form-control-sm text-center" data-type="T1" value="6" min="0" max="500" onchange="onECSChange()"></td>
            </tr>
            <tr>
              <td class="align-middle">T2</td>
              <td class="align-middle text-center mono text-muted" id="eqT2">0.7</td>
              <td><input type="number" class="form-control form-control-sm text-center" data-type="T2" value="12" min="0" max="500" onchange="onECSChange()"></td>
            </tr>
            <tr>
              <td class="align-middle">T3</td>
              <td class="align-middle text-center mono text-muted" id="eqT3">1.0</td>
              <td><input type="number" class="form-control form-control-sm text-center" data-type="T3" value="20" min="0" max="500" onchange="onECSChange()"></td>
            </tr>
            <tr>
              <td class="align-middle">T4</td>
              <td class="align-middle text-center mono text-muted" id="eqT4">1.4</td>
              <td><input type="number" class="form-control form-control-sm text-center" data-type="T4" value="8" min="0" max="500" onchange="onECSChange()"></td>
            </tr>
            <tr>
              <td class="align-middle">T5+</td>
              <td class="align-middle text-center mono text-muted" id="eqT5">1.8</td>
              <td><input type="number" class="form-control form-control-sm text-center" data-type="T5" value="4" min="0" max="500" onchange="onECSChange()"></td>
            </tr>
          </tbody>
        </table>
      </div>
      <div id="ecsTertiaire" style="display:none">
        <div class="mb-3">
          <label class="form-label" for="ecsUnits">Nombre d'unites</label>
          <input type="number" class="form-control" id="ecsUnits" value="50" min="1" max="5000" onchange="onECSChange()">
        </div>
      </div>
    </div>

    <!-- HYBRID -->
    <div class="p-3 border-bottom" id="sectionHybrid" style="display:none">
      <div class="section-head">Chaudiere d'appoint</div>
      <div class="mb-3">
        <label class="form-label" for="boilerType">Type de chaudiere</label>
        <select class="form-select" id="boilerType" onchange="onHybridChange()">
          <option value="gaz_condensation">Gaz condensation (&eta;=0.95)</option>
          <option value="gaz_standard">Gaz standard (&eta;=0.85)</option>
          <option value="fioul">Fioul (&eta;=0.90)</option>
        </select>
      </div>
      <div class="mb-3">
        <label class="form-label" for="bivalentMode">Mode bivalent</label>
        <select class="form-select" id="bivalentMode" onchange="onHybridChange()">
          <option value="parallel">Bivalent parallele</option>
          <option value="alternatif">Bivalent alternatif</option>
        </select>
      </div>
    </div>

    <!-- CALCULATE -->
    <div class="p-3">
      <button class="btn btn-atlantic w-100 btn-lg" onclick="calculate()" id="btnCalc">
        <i class="ti ti-calculator me-2"></i>Dimensionner
      </button>
    </div>
  </div>

  <!-- ===== RIGHT: RESULTS PANEL ===== -->
  <div class="panel-results" id="panelRight">
    <div class="results-placeholder" id="placeholder">
      <i class="ti ti-snowflake" style="font-size:48px;opacity:.2"></i>
      <p>Renseignez les parametres du projet puis cliquez sur <strong>Dimensionner</strong> pour obtenir les solutions PAC.</p>
    </div>
    <div id="results" style="display:none"></div>
  </div>

</div>

<!-- ===== SCRIPTS ===== -->
<script src="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta20/dist/js/tabler.min.js"></script>
<script src="data/performance.js"></script>
<script src="assets/js/engine.js"></script>
<script>
// ============================================================
// APP STATE
// ============================================================
let state = {
  mode: 'elec',
  dept: '75',
  altitude: 0,
  bordMer: false,
  tbase: -5,
  zone: 'D',
  climat: 'H1c',
  buildingType: 're2020',
  surface: 1500,
  tInt: 19,
  deperditionsKW: 0,
  dp: 0,
  gamme: 'effipac',
  tWater: 45,
  deltaT: 5,
  solutions: [],
  selectedIdx: 0,
  ecsResult: null,
  monotoneChart: null
};

// ============================================================
// INIT
// ============================================================
function init() {
  const deptSelect = document.getElementById('dept');
  const depts = Object.keys(PERFORMANCE_DATA.tbase).sort((a,b) => {
    if (a === '2A' || a === '2B' || b === '2A' || b === '2B') return a < b ? -1 : a > b ? 1 : 0;
    return parseInt(a) - parseInt(b);
  });
  for (const d of depts) {
    const opt = document.createElement('option');
    opt.value = d;
    opt.textContent = d + ' \u2014 ' + getDeptName(d);
    if (d === '75') opt.selected = true;
    deptSelect.appendChild(opt);
  }

  const btSelect = document.getElementById('buildingType');
  for (const [key, val] of Object.entries(PERFORMANCE_DATA.buildingTypes)) {
    const opt = document.createElement('option');
    opt.value = key;
    opt.textContent = val.label + ' (' + val.description + ')';
    if (key === 're2020') opt.selected = true;
    btSelect.appendChild(opt);
  }

  onDeptChange();
  onBuildingChange();
}

function getDeptName(code) {
  const names = {
    "01":"Ain","02":"Aisne","03":"Allier","04":"Alpes-de-Haute-Provence","05":"Hautes-Alpes",
    "06":"Alpes-Maritimes","07":"Ardeche","08":"Ardennes","09":"Ariege","10":"Aube",
    "11":"Aude","12":"Aveyron","13":"Bouches-du-Rhone","14":"Calvados","15":"Cantal",
    "16":"Charente","17":"Charente-Maritime","18":"Cher","19":"Correze",
    "2A":"Corse-du-Sud","2B":"Haute-Corse",
    "21":"Cote-d'Or","22":"Cotes-d'Armor","23":"Creuse","24":"Dordogne","25":"Doubs",
    "26":"Drome","27":"Eure","28":"Eure-et-Loir","29":"Finistere","30":"Gard",
    "31":"Haute-Garonne","32":"Gers","33":"Gironde","34":"Herault","35":"Ille-et-Vilaine",
    "36":"Indre","37":"Indre-et-Loire","38":"Isere","39":"Jura","40":"Landes",
    "41":"Loir-et-Cher","42":"Loire","43":"Haute-Loire","44":"Loire-Atlantique","45":"Loiret",
    "46":"Lot","47":"Lot-et-Garonne","48":"Lozere","49":"Maine-et-Loire","50":"Manche",
    "51":"Marne","52":"Haute-Marne","53":"Mayenne","54":"Meurthe-et-Moselle","55":"Meuse",
    "56":"Morbihan","57":"Moselle","58":"Nievre","59":"Nord","60":"Oise",
    "61":"Orne","62":"Pas-de-Calais","63":"Puy-de-Dome","64":"Pyrenees-Atlantiques",
    "65":"Hautes-Pyrenees","66":"Pyrenees-Orientales","67":"Bas-Rhin","68":"Haut-Rhin",
    "69":"Rhone","70":"Haute-Saone","71":"Saone-et-Loire","72":"Sarthe","73":"Savoie",
    "74":"Haute-Savoie","75":"Paris","76":"Seine-Maritime","77":"Seine-et-Marne",
    "78":"Yvelines","79":"Deux-Sevres","80":"Somme","81":"Tarn","82":"Tarn-et-Garonne",
    "83":"Var","84":"Vaucluse","85":"Vendee","86":"Vienne","87":"Haute-Vienne",
    "88":"Vosges","89":"Yonne","90":"Territoire de Belfort",
    "91":"Essonne","92":"Hauts-de-Seine","93":"Seine-Saint-Denis","94":"Val-de-Marne","95":"Val-d'Oise"
  };
  return names[code] || code;
}

// ============================================================
// EVENT HANDLERS
// ============================================================
function switchMode(mode) {
  state.mode = mode;
  document.querySelectorAll('#tabs .nav-link').forEach(a => {
    a.classList.toggle('active', a.dataset.mode === mode);
  });

  document.getElementById('sectionPAC').style.display = mode !== 'ecs' ? '' : 'none';
  document.getElementById('sectionECS').style.display = (mode === 'ecs' || mode === 'double') ? '' : 'none';
  document.getElementById('sectionHybrid').style.display = mode === 'hybrid' ? '' : 'none';
}

function onDeptChange() {
  state.dept = document.getElementById('dept').value;
  onLocationChange();
}

function onLocationChange() {
  state.altitude = parseInt(document.getElementById('altitude').value) || 0;
  state.bordMer = document.getElementById('bordMer').checked;

  const d = PERFORMANCE_DATA.tbase[state.dept];
  if (d) {
    state.tbase = SizingEngine.getTbase(state.dept, state.altitude, state.bordMer);
    state.zone = d.zone;
    state.climat = d.climat;
  }

  document.getElementById('rdTbase').innerHTML = state.tbase + '&deg;C';
  document.getElementById('rdZone').textContent = state.zone;
  document.getElementById('rdClimat').textContent = state.climat;
  onBuildingChange();
}

function onBuildingChange() {
  state.buildingType = document.getElementById('buildingType').value;
  state.surface = parseInt(document.getElementById('surface').value) || 1500;
  state.tInt = parseInt(document.getElementById('tConsigne').value) || 19;

  const result = SizingEngine.calcDeperditions({
    surface: state.surface,
    buildingType: state.buildingType,
    tInt: state.tInt,
    tBase: state.tbase
  });

  if (result) {
    state.deperditionsKW = result.deperditionsKW;
    state.dp = result.dp;
    document.getElementById('rdDep').innerHTML = result.deperditionsKW.toFixed(1) + ' <small class="text-muted" style="font-size:.7rem">kW</small>';
    document.getElementById('rdDp').innerHTML = result.dp.toFixed(1) + ' <small class="text-muted" style="font-size:.7rem">W/K</small>';
  }
}

function onPACChange() {
  state.gamme = document.querySelector('input[name="gamme"]:checked').value;
  state.tWater = parseInt(document.getElementById('tWater').value);
  state.deltaT = parseInt(document.getElementById('deltaT').value);
}

function onECSChange() {
  const ecsType = document.getElementById('ecsType').value;
  const isLogements = ecsType === 'logements';
  document.getElementById('ecsLogements').style.display = isLogements ? '' : 'none';
  document.getElementById('ecsTertiaire').style.display = isLogements ? 'none' : '';

  if (isLogements) {
    const parc = document.querySelector('input[name="parc"]:checked').value;
    const coeffs = PERFORMANCE_DATA.ecs.equivalenceParc[parc];
    document.getElementById('eqT1').textContent = coeffs.T1;
    document.getElementById('eqT2').textContent = coeffs.T2;
    document.getElementById('eqT3').textContent = coeffs.T3;
    document.getElementById('eqT4').textContent = coeffs.T4;
    document.getElementById('eqT5').textContent = coeffs.T5;
  }
}

function onHybridChange() {}

// ============================================================
// CALCULATE
// ============================================================
function calculate() {
  const btn = document.getElementById('btnCalc');
  btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Calcul en cours...';
  btn.disabled = true;

  setTimeout(() => {
    try { doCalculate(); }
    finally { btn.innerHTML = '<i class="ti ti-calculator me-2"></i>Dimensionner'; btn.disabled = false; }
  }, 50);
}

function doCalculate() {
  let html = '';

  if (state.mode === 'ecs') {
    html = calcECS();
  } else {
    const solutions = SizingEngine.selectPAC({
      deperditionsKW: state.deperditionsKW,
      gamme: state.gamme,
      tWater: state.tWater,
      mode: state.mode === 'hybrid' ? 'hybrid' : 'elec',
      tBase: state.tbase,
      tInt: state.tInt
    });

    state.solutions = solutions;
    state.selectedIdx = 0;

    if (solutions.length === 0) {
      html = '<div class="results-placeholder"><p>Aucune solution trouvee. Modifiez la gamme PAC ou la surface.</p></div>';
    } else {
      html = renderSolutions(solutions);
    }
  }

  document.getElementById('placeholder').style.display = 'none';
  const r = document.getElementById('results');
  r.style.display = '';
  r.innerHTML = html;

  if (state.mode !== 'ecs' && state.solutions.length > 0) {
    selectSolution(0);
  }
}

// ============================================================
// RENDER SOLUTIONS
// ============================================================
function renderSolutions(solutions) {
  let html = '<div class="solutions-grid">';
  solutions.forEach((sol, i) => {
    const ok = sol.taux_couverture >= 90, warn = sol.taux_couverture >= 70 && sol.taux_couverture < 90;
    html += `
    <div class="card sol-card fade-up ${i===0?'selected':''}" onclick="selectSolution(${i})" id="card${i}">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start mb-3">
          <div>
            <h3 class="mb-0" style="color:var(--atlantic)">${sol.pac.nom}</h3>
            <small class="text-muted">${sol.nombre > 1 ? sol.nombre + ' unites en cascade' : '1 unite'}</small>
          </div>
          <span class="badge ${sol.pac.refrigerant==='R290'?'bg-green-lt':'bg-blue-lt'}">${sol.pac.refrigerant}</span>
        </div>
        <div class="metric-grid">
          <div class="metric-box"><div class="m-label">P. nominale</div><div class="m-value">${sol.puissance_totale_nom.toFixed(1)} <span class="m-unit">kW</span></div></div>
          <div class="metric-box"><div class="m-label">Part PAC Tbase</div><div class="m-value ${ok?'good':warn?'warn':''}">${sol.part_pac.toFixed(1)} <span class="m-unit">%</span></div></div>
          <div class="metric-box"><div class="m-label">Taux couverture</div><div class="m-value ${ok?'good':warn?'warn':''}">${sol.taux_couverture.toFixed(1)} <span class="m-unit">%</span></div></div>
          <div class="metric-box"><div class="m-label">COP A7</div><div class="m-value">${sol.cop_a7 ? sol.cop_a7.toFixed(2) : '\u2014'}</div></div>
        </div>
      </div>
    </div>`;
  });
  html += '</div>';

  html += '<div id="detailArea"></div>';
  html += '<div class="card detail-card fade-up mb-3"><div class="card-header"><h3 class="card-title"><span class="badge-bar" style="background:#1a73e8"></span>Courbe monotone de chauffage</h3></div><div class="card-body"><div id="monotoneChart" class="chart-box"></div></div></div>';
  html += '<div id="comparisonArea"></div>';

  return html;
}

// ============================================================
// SELECT SOLUTION & DETAIL
// ============================================================
function selectSolution(idx) {
  state.selectedIdx = idx;
  const sol = state.solutions[idx];
  if (!sol) return;

  document.querySelectorAll('.sol-card').forEach((c,i) => c.classList.toggle('selected', i===idx));

  const energy = SizingEngine.calcAnnualEnergy({
    deperditionsKW: state.deperditionsKW, dp: state.dp, tInt: state.tInt, tBase: state.tbase,
    model: sol.pac, nombre: sol.nombre, tWater: state.tWater, climat: state.climat,
    mode: state.mode === 'hybrid' ? 'hybrid' : 'elec'
  });

  const hyd = SizingEngine.calcHydraulics(sol.puissance_totale_nom, state.deltaT);

  let biv = null;
  if (state.mode === 'hybrid') {
    biv = SizingEngine.calcBivalentPoint({
      deperditionsKW: state.deperditionsKW, dp: state.dp, tInt: state.tInt, tBase: state.tbase,
      model: sol.pac, nombre: sol.nombre, tWater: state.tWater
    });
  }

  // Detail table
  let detail = `<div class="card detail-card fade-up mb-3">
    <div class="card-header"><h3 class="card-title"><span class="badge-bar" style="background:var(--orange)"></span>Resultats detailles &mdash; ${sol.pac.nom} &times;${sol.nombre}</h3></div>
    <div class="card-body p-0">
      <table class="table table-striped table-hover mb-0">
        <tbody>
          <tr><td>Puissance calorifique nominale</td><td class="mono text-end">${sol.puissance_totale_nom.toFixed(1)} kW</td></tr>
          <tr><td>Puissance a Tbase (${state.tbase}&deg;C)</td><td class="mono text-end">${sol.puissance_totale_tbase.toFixed(1)} kW</td></tr>
          <tr><td>Part PAC a Tbase</td><td class="mono text-end highlight">${sol.part_pac.toFixed(1)} %</td></tr>
          <tr><td>Taux de couverture annuel</td><td class="mono text-end highlight">${energy.tauxCouverture.toFixed(1)} %</td></tr>
          <tr><td>SCOP pondere</td><td class="mono text-end">${energy.scopWeighted.toFixed(2)}</td></tr>
          <tr><td>Energie PAC annuelle</td><td class="mono text-end">${(energy.ePac/1000).toFixed(0)} MWh</td></tr>
          <tr><td>Energie appoint annuelle</td><td class="mono text-end">${(energy.eBackup/1000).toFixed(0)} MWh</td></tr>
          <tr><td>Consommation elec PAC</td><td class="mono text-end">${(energy.elecPac/1000).toFixed(0)} MWh</td></tr>
          <tr><td>Puissance electrique absorbee max</td><td class="mono text-end">${sol.pabs_tbase.toFixed(1)} kW</td></tr>
          <tr><td>Intensite max (400V tri)</td><td class="mono text-end">${(sol.pabs_tbase * 1000 / (400 * 1.732)).toFixed(1)} A</td></tr>
          ${biv ? `<tr><td>Point de bivalence</td><td class="mono text-end highlight">${biv.tBivalent.toFixed(1)}&deg;C</td></tr>` : ''}
        </tbody>
      </table>
    </div>
  </div>`;

  // Hydraulics
  detail += `<div class="card detail-card fade-up mb-3">
    <div class="card-header"><h3 class="card-title"><span class="badge-bar" style="background:#0891b2"></span>Hydraulique</h3></div>
    <div class="card-body p-0">
      <table class="table table-striped table-hover mb-0">
        <tbody>
          <tr><td>Debit primaire PAC</td><td class="mono text-end">${hyd.debit_m3h.toFixed(2)} m&sup3;/h (${hyd.debit_Lh} L/h)</td></tr>
          <tr><td>Delta T</td><td class="mono text-end">${hyd.deltaT} K</td></tr>
          <tr><td>Diametre raccordement</td><td class="mono text-end">&empty;${hyd.diametre_int}/${hyd.diametre_ext} mm</td></tr>
          <tr><td>Diametre bouteille decouplage</td><td class="mono text-end">&empty;${hyd.diametre_bouteille} mm</td></tr>
          <tr><td>Ballon tampon recommande</td><td class="mono text-end highlight">${hyd.ballon_tampon_L} L</td></tr>
        </tbody>
      </table>
    </div>
  </div>`;

  document.getElementById('detailArea').innerHTML = detail;
  renderMonotoneChart(sol, energy);
  renderComparison(sol);
}

// ============================================================
// ECHARTS MONOTONE
// ============================================================
function renderMonotoneChart(sol, energy) {
  const container = document.getElementById('monotoneChart');
  if (!container) return;

  if (state.monotoneChart) { state.monotoneChart.dispose(); state.monotoneChart = null; }

  const data = SizingEngine.generateMonotoneData({
    deperditionsKW: state.deperditionsKW, dp: state.dp, tInt: state.tInt, tBase: state.tbase,
    climat: state.climat, model: sol.pac, nombre: sol.nombre, tWater: state.tWater
  });

  const hours = data.map(d => d.hours);
  const loads = data.map(d => d.load);
  const pacCaps = data.map(d => d.pacCapacity);

  state.monotoneChart = echarts.init(container);
  state.monotoneChart.setOption({
    tooltip: {
      trigger: 'axis',
      backgroundColor: '#fff',
      borderColor: '#e5e7eb',
      borderWidth: 1,
      textStyle: { color: '#1a2332', fontFamily: "'Source Sans 3', sans-serif", fontSize: 13 },
      formatter: function(params) {
        let s = '<strong>' + params[0].axisValueLabel + ' h</strong><br/>';
        params.forEach(p => {
          s += '<span style="display:inline-block;width:10px;height:10px;border-radius:2px;background:' + p.color + ';margin-right:6px"></span>';
          s += p.seriesName + ': <strong>' + p.value.toFixed(1) + ' kW</strong><br/>';
        });
        return s;
      }
    },
    legend: {
      data: ['Besoin chauffage', 'Capacite PAC'],
      bottom: 0,
      textStyle: { fontFamily: "'Source Sans 3', sans-serif", fontSize: 12, color: '#6b7280' }
    },
    grid: { top: 20, right: 20, bottom: 50, left: 60 },
    xAxis: {
      type: 'category',
      data: hours,
      name: 'Heures cumulees',
      nameLocation: 'center',
      nameGap: 30,
      nameTextStyle: { fontFamily: "'Source Sans 3', sans-serif", fontSize: 12, color: '#9ca3af' },
      axisLabel: { fontFamily: "'DM Mono', monospace", fontSize: 10, color: '#9ca3af',
        formatter: function(v,i){ return i % Math.ceil(hours.length/8) === 0 ? v : ''; } },
      axisLine: { lineStyle: { color: '#e5e7eb' } },
      axisTick: { show: false },
      splitLine: { show: false }
    },
    yAxis: {
      type: 'value',
      name: 'Puissance (kW)',
      nameTextStyle: { fontFamily: "'Source Sans 3', sans-serif", fontSize: 12, color: '#9ca3af' },
      axisLabel: { fontFamily: "'DM Mono', monospace", fontSize: 10, color: '#9ca3af' },
      axisLine: { show: false },
      splitLine: { lineStyle: { color: '#f3f4f6', type: 'dashed' } }
    },
    series: [
      {
        name: 'Besoin chauffage',
        type: 'line',
        data: loads,
        smooth: 0.3,
        symbol: 'none',
        lineStyle: { width: 1.5, color: '#94a3b8' },
        areaStyle: { color: new echarts.graphic.LinearGradient(0,0,0,1,[
          {offset:0,color:'rgba(148,163,184,0.15)'},{offset:1,color:'rgba(148,163,184,0.01)'}
        ])}
      },
      {
        name: 'Capacite PAC',
        type: 'line',
        data: pacCaps,
        smooth: 0.3,
        symbol: 'none',
        lineStyle: { width: 2.5, color: '#e8622a', type: 'dashed' },
        areaStyle: { color: new echarts.graphic.LinearGradient(0,0,0,1,[
          {offset:0,color:'rgba(232,98,42,0.12)'},{offset:1,color:'rgba(232,98,42,0.01)'}
        ])}
      }
    ]
  });
}

// Resize charts on window resize
window.addEventListener('resize', function() {
  if (state.monotoneChart) state.monotoneChart.resize();
});

// ============================================================
// COMPETITOR COMPARISON
// ============================================================
function renderComparison(sol) {
  const comparisons = SizingEngine.compareWithCompetitors(sol, state.deperditionsKW, state.tbase, state.tWater);

  let html = `<div class="card detail-card fade-up mb-3">
    <div class="card-header"><h3 class="card-title"><span class="badge-bar" style="background:#16a34a"></span>Comparaison concurrents</h3></div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-striped table-hover table-nowrap mb-0">
          <thead>
            <tr>
              <th>Marque / Gamme</th><th>Modele</th><th class="text-center">Qty</th>
              <th class="text-end">P. nom.</th><th>Refrig.</th><th class="text-end">T max</th>
              <th class="text-end">COP A7</th><th class="text-end">Part PAC</th><th class="text-end">Couverture</th>
            </tr>
          </thead>
          <tbody>`;

  for (const c of comparisons) {
    const cls = c.isAtlantic ? ' class="atlantic-row"' : '';
    html += `<tr${cls}>
      <td><strong>${c.brand}</strong></td>
      <td class="mono">${c.model}</td>
      <td class="mono text-center">${c.nombre}</td>
      <td class="mono text-end">${c.puissance_nom.toFixed(1)} kW</td>
      <td>${c.refrigerant}</td>
      <td class="mono text-end">${c.t_max}&deg;C</td>
      <td class="mono text-end">${c.cop_a7 ? c.cop_a7.toFixed(2) : '\u2014'}</td>
      <td class="mono text-end">${c.part_pac.toFixed(1)}%</td>
      <td class="mono text-end">${c.taux_couverture.toFixed(1)}%</td>
    </tr>`;
  }

  html += '</tbody></table></div></div></div>';
  document.getElementById('comparisonArea').innerHTML = html;
}

// ============================================================
// ECS CALCULATION
// ============================================================
function calcECS() {
  const ecsType = document.getElementById('ecsType').value;
  let ecsResult;

  if (ecsType === 'logements') {
    const parc = document.querySelector('input[name="parc"]:checked').value;
    const logements = [];
    document.querySelectorAll('#ecsGrid input[type="number"]').forEach(inp => {
      const type = inp.dataset.type;
      const count = parseInt(inp.value) || 0;
      if (count > 0) logements.push({ type, count });
    });
    ecsResult = SizingEngine.calcECS({ logements, parc });
  } else {
    const units = parseInt(document.getElementById('ecsUnits').value) || 50;
    ecsResult = SizingEngine.calcECS({ buildingType: ecsType, units });
  }

  if (!ecsResult) return '<div class="results-placeholder"><p>Erreur de calcul ECS.</p></div>';
  state.ecsResult = ecsResult;

  let html = `<div class="card detail-card fade-up mb-3">
    <div class="card-header"><h3 class="card-title"><span class="badge-bar" style="background:#16a34a"></span>Resultats ECS</h3></div>
    <div class="card-body p-0">
      <table class="table table-striped mb-0"><tbody>`;

  if (ecsResult.ns !== undefined) {
    html += `
      <tr><td>Nombre de logements standards (Ns)</td><td class="mono text-end highlight">${ecsResult.ns}</td></tr>
      <tr><td>Volume journalier a 60&deg;C</td><td class="mono text-end">${ecsResult.vj} L/jour</td></tr>
      <tr><td>Volume de pointe 10 min</td><td class="mono text-end">${ecsResult.v10} L</td></tr>
      <tr><td>Volume de pointe 1h</td><td class="mono text-end">${ecsResult.v1h} L</td></tr>
      <tr><td>Volume stockage minimum</td><td class="mono text-end highlight">${ecsResult.vStockage} L</td></tr>
      <tr><td>Puissance production (semi-accum.)</td><td class="mono text-end highlight">${ecsResult.pProduction} kW</td></tr>
      <tr><td>Puissance instantanee</td><td class="mono text-end">${ecsResult.pInstantanee} kW</td></tr>`;
  } else {
    html += `
      <tr><td>Type</td><td class="text-end">${ecsResult.type}</td></tr>
      <tr><td>Nombre de ${ecsResult.unite}s</td><td class="mono text-end">${ecsResult.nombre}</td></tr>
      <tr><td>Volume journalier a 60&deg;C</td><td class="mono text-end">${ecsResult.vj} L/jour</td></tr>
      <tr><td>Puissance accumulation (8h)</td><td class="mono text-end highlight">${ecsResult.pAccumulation} kW</td></tr>`;
  }

  html += `
      <tr><td>Temperature ECS</td><td class="mono text-end">${ecsResult.tEcs}&deg;C</td></tr>
      <tr><td>Temperature eau froide</td><td class="mono text-end">${ecsResult.tEf}&deg;C</td></tr>
    </tbody></table></div></div>`;

  // Legionella
  html += `<div class="card detail-card card-danger-accent fade-up mb-3">
    <div class="card-header"><h3 class="card-title text-danger"><i class="ti ti-alert-triangle me-2"></i>Prevention legionellose</h3></div>
    <div class="card-body p-0">
      <table class="table table-striped mb-0"><tbody>
        <tr><td>Stockage minimum</td><td class="mono text-end">&ge; 55&deg;C</td></tr>
        <tr><td>Distribution minimum</td><td class="mono text-end">&ge; 50&deg;C en tout point</td></tr>
        <tr><td>Choc thermique quotidien</td><td class="mono text-end">60&deg;C pendant 30 min</td></tr>
        <tr><td>Robinet salle de bain</td><td class="mono text-end">&le; 50&deg;C</td></tr>
      </tbody></table>
    </div>
  </div>`;

  return html;
}

// ============================================================
// BOOTSTRAP
// ============================================================
init();
</script>
</body>
</html>
