<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>PAC Dimensionnement — Outil de dimensionnement PAC collectives</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta20/dist/css/tabler.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/dist/tabler-icons.min.css">
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<style>
:root{
  --mono:'DM Mono',monospace;
  --atlantic:#003366;
  --atlantic-light:#004488;
  --orange:#e8622a;
  --orange-hover:#f07830;
  --header-h:56px;
}
body{background:#f1f5f9;overflow-x:hidden}

/* ===== HEADER ===== */
.app-header{background:var(--atlantic);height:var(--header-h);display:flex;align-items:center;
  padding:0 16px;position:sticky;top:0;z-index:100;box-shadow:0 1px 4px rgba(0,0,0,.15);width:100%}
.app-brand{display:flex;align-items:center;gap:10px;flex-shrink:0;text-decoration:none}
.app-brand svg{width:28px;height:28px;flex-shrink:0}
.app-brand-text{color:#fff;font-weight:700;font-size:1rem;white-space:nowrap}
.app-brand-sub{color:rgba(255,255,255,.45);font-size:.7rem;font-weight:400}
/* Desktop tabs */
.mode-tabs{display:flex;gap:2px;margin-left:auto}
.mode-tab{padding:8px 16px;color:rgba(255,255,255,.5);font-size:.8rem;font-weight:600;cursor:pointer;
  border-radius:6px 6px 0 0;transition:all .15s;white-space:nowrap;user-select:none;text-decoration:none;display:flex;align-items:center;gap:6px}
.mode-tab:hover{color:rgba(255,255,255,.8);background:rgba(255,255,255,.06)}
.mode-tab.active{color:#fff;background:rgba(255,255,255,.12);box-shadow:inset 0 -2px 0 var(--orange)}
.mode-tab .dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
/* Mobile mode selector */
.mode-mobile{display:none;width:100%;padding:10px 16px;background:#fff;border-bottom:1px solid #e5e7eb}
.mode-mobile select{font-weight:600}
@media(max-width:991px){.mode-tabs{display:none}.mode-mobile{display:block}}

/* ===== APP LAYOUT ===== */
.app-main{display:grid;grid-template-columns:400px 1fr;min-height:calc(100vh - var(--header-h));overflow:hidden;max-width:100vw}
@media(min-width:992px){
  .app-col-input,.app-col-results{height:calc(100vh - var(--header-h));overflow-y:auto}
}
@media(max-width:991px){
  .app-main{grid-template-columns:1fr;min-height:auto}
  .app-col-input{border-bottom:2px solid #e5e7eb}
  .app-col-results{min-height:50vh}
  /* Mobile: hide inputs when results are showing */
  .app-main.has-results .app-col-input{display:none}
  .app-main.has-results .app-col-results{min-height:calc(100vh - var(--header-h))}
}
.app-col-input{background:#fff;border-right:1px solid #e5e7eb;min-width:0}
.app-col-results{background:#f1f5f9;padding:20px;min-width:0;overflow-x:hidden}
@media(max-width:575px){.app-col-results{padding:12px}}
/* Scrollbar */
.app-col-input::-webkit-scrollbar,.app-col-results::-webkit-scrollbar{width:4px}
.app-col-input::-webkit-scrollbar-thumb,.app-col-results::-webkit-scrollbar-thumb{background:#d1d5db;border-radius:2px}

/* ===== FORM SECTIONS ===== */
.form-section{padding:16px;border-bottom:1px solid #f0f1f3}
.form-section:last-child{border-bottom:none}
.section-label{font-size:.68rem;font-weight:800;text-transform:uppercase;letter-spacing:.12em;
  color:var(--atlantic);margin-bottom:12px;display:flex;align-items:center;gap:8px}
.section-label i{font-size:1rem;opacity:.5}
.form-label{font-size:.8rem;font-weight:600;color:#374151;margin-bottom:4px}
.form-control,.form-select{font-size:.88rem;border-radius:8px;border:1.5px solid #d1d5db;transition:all .15s}
.form-control:focus,.form-select:focus{border-color:#6366f1;box-shadow:0 0 0 3px rgba(99,102,241,.1)}
.form-control:hover,.form-select:hover{border-color:#9ca3af}
/* Number input wider stepper */
input[type="number"]{font-family:var(--mono)}
input[type="number"]::-webkit-inner-spin-button{opacity:0;height:32px;cursor:pointer}
input[type="number"]:hover::-webkit-inner-spin-button,input[type="number"]:focus::-webkit-inner-spin-button{opacity:1}

/* ===== STAT READOUT ===== */
.stat-row{display:grid;gap:8px;margin-top:12px}
.stat-row.cols-3{grid-template-columns:repeat(3,1fr)}
.stat-row.cols-2{grid-template-columns:repeat(2,1fr)}
.stat-box{background:#f8fafc;border:1px solid #e5e7eb;border-radius:8px;padding:10px;text-align:center}
.stat-box .s-label{font-size:.6rem;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:#9ca3af}
.stat-box .s-value{font-family:var(--mono);font-size:1.2rem;font-weight:500;color:var(--atlantic);margin-top:2px}
.stat-box .s-value.teal{color:#0891b2}
.stat-box .s-unit{font-size:.65rem;color:#9ca3af;font-weight:400;margin-left:2px}

/* ===== SELECTGROUP (radio toggle) ===== */
.form-selectgroup{width:100%}
.form-selectgroup-item{flex:1}
.form-selectgroup-label{justify-content:center;font-weight:600;font-size:.85rem}

/* ===== STICKY CALCULATE BUTTON (mobile) ===== */
.calc-section{padding:16px}
@media(max-width:991px){
  .calc-section{position:sticky;bottom:0;z-index:50;background:#fff;border-top:1px solid #e5e7eb;
    box-shadow:0 -4px 12px rgba(0,0,0,.08);padding:12px 16px}
}
.btn-calc{background:var(--orange);border-color:var(--orange);color:#fff;font-weight:700;font-size:1rem;
  border-radius:10px;padding:12px;transition:all .2s}
.btn-calc:hover{background:var(--orange-hover);border-color:var(--orange-hover);color:#fff;
  transform:translateY(-1px);box-shadow:0 4px 16px rgba(232,98,42,.3)}
.btn-calc:active{transform:translateY(0)}

/* ===== PLACEHOLDER ===== */
.results-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;
  min-height:400px;text-align:center;gap:12px;color:#94a3af}
.results-empty p{max-width:350px;line-height:1.7;font-size:.9rem}

/* ===== SOLUTION CARDS ===== */
.sol-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;margin-bottom:20px}
@media(max-width:575px){.sol-grid{grid-template-columns:1fr}}
.sol-card{background:#fff;border:1.5px solid #e5e7eb;border-radius:12px;padding:16px;
  cursor:pointer;transition:all .2s;position:relative}
.sol-card:hover{border-color:var(--orange);box-shadow:0 4px 16px rgba(0,0,0,.06)}
.sol-card.active{border-color:var(--orange);box-shadow:0 0 0 2px var(--orange)}
.sol-card.active::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;
  background:var(--orange);border-radius:12px 12px 0 0}
.sol-card .sol-name{font-weight:700;font-size:1.05rem;color:var(--atlantic)}
.sol-card .sol-sub{font-size:.78rem;color:#9ca3af;margin-top:1px}
.sol-metrics{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:12px}
.sol-metric{background:#f8fafc;border-radius:6px;padding:8px 10px}
.sol-metric .sm-label{font-size:.6rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:#9ca3af}
.sol-metric .sm-value{font-family:var(--mono);font-size:.95rem;font-weight:500;margin-top:2px}
.sm-value .sm-unit{font-size:.7rem;color:#9ca3af;font-weight:400}
.sm-value.good{color:#16a34a}
.sm-value.warn{color:var(--orange)}

/* ===== RESULT CARDS ===== */
.res-card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;overflow:hidden;margin-bottom:16px;
  box-shadow:0 1px 3px rgba(0,0,0,.03)}
.res-card-head{padding:14px 16px;border-bottom:1px solid #f0f1f3;display:flex;align-items:center;gap:8px;
  font-weight:700;font-size:.9rem;color:#1f2937}
.res-card-head .bar{width:3px;height:16px;border-radius:2px;flex-shrink:0}
.res-card-body{padding:0}
.res-card-body.padded{padding:16px}
/* Tables in result cards */
.res-card .table{margin:0;font-size:.85rem}
.res-card .table td,.res-card .table th{padding:10px 16px}
.res-card .table td:last-child{text-align:right;font-family:var(--mono)}
.res-card .table{table-layout:auto;width:100%}
.res-card .res-card-body{overflow-x:auto}
.res-card .table .hl{color:var(--orange);font-weight:700}
.res-card .table .atlantic-row{background:rgba(232,98,42,.04)}
.res-card .table .atlantic-row td:first-child{border-left:3px solid var(--orange)}

/* ===== SCHEMA THUMBNAILS ===== */
.schema-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px}
@media(max-width:575px){.schema-grid{grid-template-columns:repeat(2,1fr)}}
.schema-thumb{border:1.5px solid #e5e7eb;border-radius:8px;overflow:hidden;cursor:pointer;
  transition:all .2s;background:#fff}
.schema-thumb:hover{border-color:var(--atlantic);box-shadow:0 4px 12px rgba(0,0,0,.08);transform:translateY(-2px)}
.schema-thumb img{width:100%;height:120px;object-fit:contain;padding:8px;background:#fafafa}
.schema-thumb .st-label{padding:6px 10px;font-size:.72rem;font-weight:600;color:#6b7280;
  border-top:1px solid #f0f1f3;text-align:center;background:#fff}

/* ===== LIGHTBOX MODAL ===== */
.lightbox-overlay{display:none;position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,.85);
  align-items:center;justify-content:center;padding:20px;cursor:zoom-out}
.lightbox-overlay.open{display:flex}
.lightbox-overlay img{max-width:100%;max-height:90vh;object-fit:contain;border-radius:8px;
  box-shadow:0 8px 40px rgba(0,0,0,.4)}
.lightbox-close{position:fixed;top:16px;right:16px;width:40px;height:40px;border-radius:50%;
  background:rgba(255,255,255,.15);color:#fff;border:none;font-size:1.2rem;cursor:pointer;
  display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px);z-index:10000}
.lightbox-close:hover{background:rgba(255,255,255,.3)}
.lightbox-title{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);color:rgba(255,255,255,.7);
  font-size:.85rem;font-weight:500;z-index:10000;background:rgba(0,0,0,.5);padding:6px 16px;border-radius:20px}

/* ===== CHART ===== */
.chart-box{width:100%;height:400px}
@media(max-width:575px){.chart-box{height:300px}}

/* ===== ECS TABLE ===== */
.ecs-grid .form-control{text-align:center;padding:6px 8px}

/* ===== DANGER ACCENT ===== */
.card-danger{border-left:3px solid #dc2626}

/* ===== ANIMATIONS ===== */
@keyframes slideUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
.anim{animation:slideUp .3s ease-out both}
.anim:nth-child(2){animation-delay:.04s}
.anim:nth-child(3){animation-delay:.08s}
.anim:nth-child(4){animation-delay:.12s}

/* ===== PDF ACTION BAR ===== */
.pdf-actions{display:inline-flex;gap:4px;margin-bottom:12px;flex-wrap:wrap;align-items:center}
.btn-pdf{background:var(--atlantic);color:#fff;font-weight:600;font-size:.72rem;
  border-radius:6px;padding:5px 10px;display:inline-flex;align-items:center;gap:4px;transition:all .15s;cursor:pointer;border:none}
.btn-pdf:hover{background:var(--atlantic-light);color:#fff;box-shadow:0 2px 8px rgba(0,51,102,.15)}
.btn-pdf.orange{background:var(--orange)}
.btn-pdf.orange:hover{background:var(--orange-hover)}
.btn-pdf.teal{background:#0891b2}
.btn-pdf.teal:hover{background:#0e7490}
.btn-pdf i{font-size:.9rem}

/* ===== DEVIS MODAL ===== */
.devis-overlay{display:none;position:fixed;inset:0;z-index:9998;background:rgba(0,0,0,.5);
  align-items:flex-start;justify-content:center;padding:20px;overflow-y:auto}
.devis-overlay.open{display:flex}
.devis-modal{background:#fff;border-radius:12px;max-width:700px;width:100%;margin:20px auto;
  box-shadow:0 20px 60px rgba(0,0,0,.3);overflow:hidden}
.devis-header{background:var(--atlantic);color:#fff;padding:16px 24px;display:flex;align-items:center;justify-content:space-between}
.devis-header h3{margin:0;font-size:1.1rem;font-weight:700}
.devis-close{background:rgba(255,255,255,.15);border:none;color:#fff;width:32px;height:32px;border-radius:50%;
  cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1rem}
.devis-close:hover{background:rgba(255,255,255,.3)}
.devis-body{padding:24px}
.devis-body .form-label{font-weight:600;font-size:.82rem}
.devis-body .form-control{font-size:.88rem}
.devis-footer{padding:16px 24px;border-top:1px solid #e5e7eb;display:flex;gap:8px;justify-content:flex-end}

/* ===== MOBILE BACK BUTTON ===== */
.btn-back-mobile{display:none}
@media(max-width:991px){
  .btn-back-mobile{display:flex;align-items:center;gap:6px;background:var(--atlantic);color:#fff;
    border:none;border-radius:8px;padding:8px 14px;font-weight:600;font-size:.8rem;cursor:pointer;
    margin-bottom:10px;width:100%;justify-content:center}
  .btn-back-mobile:hover{background:var(--atlantic-light)}
  .pdf-actions{position:sticky;bottom:0;z-index:50;margin:0 -12px -12px;padding:8px 12px;
    border-radius:0;border:none;border-top:1px solid #e5e7eb;background:#fff;
    box-shadow:0 -2px 8px rgba(0,0,0,.06);gap:6px;display:flex;justify-content:center}
}

/* ===== COLLAPSIBLE SECTIONS ===== */
.res-card-head{cursor:pointer;user-select:none}
.res-card-head .chevron{margin-left:auto;transition:transform .2s;font-size:.9rem;color:#9ca3af}
.res-card.collapsed .res-card-body{display:none}
.res-card.collapsed .chevron{transform:rotate(-90deg)}

/* ===== PRINT ===== */
@media print{.app-header,.calc-section,.mode-mobile,.pdf-actions{display:none!important}
  .app-main{display:block!important}.app-col-input{display:none!important}
  .app-col-results{height:auto!important;overflow:visible!important}
  .res-card{break-inside:avoid;box-shadow:none!important;border:1px solid #ccc!important}}
</style>
</head>
<body>

<!-- ===== HEADER ===== -->
<header class="app-header">
  <a class="app-brand" href="#">
    <svg viewBox="0 0 32 32" fill="none"><rect width="32" height="32" rx="7" fill="#e8622a"/>
    <path d="M8 23V9h3.5l4.5 8 4.5-8H24v14h-3.5V14l-4.5 8-4.5-8v9z" fill="#fff"/></svg>
    <div>
      <div class="app-brand-text">PAC Dimensionnement</div>
      <div class="app-brand-sub d-none d-md-block">Outil de dimensionnement PAC collectives</div>
    </div>
  </a>
  <nav class="mode-tabs" id="desktopTabs">
    <a class="mode-tab active" data-mode="elec" onclick="switchMode('elec')"><span class="dot" style="background:#3b82f6"></span>Chauffage 100% Elec</a>
    <a class="mode-tab" data-mode="double" onclick="switchMode('double')"><span class="dot" style="background:#0891b2"></span>Double Service</a>
    <a class="mode-tab" data-mode="ecs" onclick="switchMode('ecs')"><span class="dot" style="background:#16a34a"></span>ECS Seul</a>
    <a class="mode-tab" data-mode="hybrid" onclick="switchMode('hybrid')"><span class="dot" style="background:#e8622a"></span>Chauffage Hybride</a>
  </nav>
</header>

<!-- MOBILE MODE SELECTOR -->
<div class="mode-mobile" id="mobileMode">
  <select class="form-select" id="modeSelect" onchange="switchMode(this.value)">
    <option value="elec" selected>Chauffage 100% Electrique</option>
    <option value="double">Double Service (Chauffage + ECS)</option>
    <option value="ecs">ECS Seul</option>
    <option value="hybrid">Chauffage Hybride (PAC + Chaudiere)</option>
  </select>
</div>

<!-- ===== MAIN ===== -->
<div class="app-main">

  <!-- ===== LEFT: INPUTS ===== -->
  <div class="app-col-input">

    <!-- LOCALISATION -->
    <div class="form-section">
      <div class="section-label"><i class="ti ti-map-pin"></i>Localisation</div>
      <div class="mb-3">
        <label class="form-label">Departement</label>
        <select class="form-select" id="dept" onchange="onDeptChange()"></select>
      </div>
      <div class="row g-2 mb-1">
        <div class="col-6">
          <label class="form-label">Altitude (m)</label>
          <input type="number" class="form-control" id="altitude" value="0" min="0" max="3000" step="50" onchange="onLocationChange()">
        </div>
        <div class="col-6 d-flex align-items-end pb-1">
          <label class="form-check form-switch mb-0">
            <input class="form-check-input" type="checkbox" id="bordMer" onchange="onLocationChange()">
            <span class="form-check-label">Bord de mer</span>
          </label>
        </div>
      </div>
      <div class="stat-row cols-3">
        <div class="stat-box"><div class="s-label">T base</div><div class="s-value teal" id="rdTbase">&mdash;</div></div>
        <div class="stat-box"><div class="s-label">Zone</div><div class="s-value" id="rdZone">&mdash;</div></div>
        <div class="stat-box"><div class="s-label">Climat</div><div class="s-value" id="rdClimat">&mdash;</div></div>
      </div>
    </div>

    <!-- BATIMENT -->
    <div class="form-section">
      <div class="section-label"><i class="ti ti-building"></i>Batiment</div>
      <div class="mb-3">
        <label class="form-label">Type de batiment</label>
        <select class="form-select" id="buildingType" onchange="onBuildingChange()"></select>
      </div>
      <div class="row g-2">
        <div class="col-7">
          <label class="form-label">Surface habitable (m&sup2;)</label>
          <input type="number" class="form-control" id="surface" value="1500" min="50" max="50000" step="50" onchange="onBuildingChange()">
        </div>
        <div class="col-5">
          <label class="form-label">T consigne (&deg;C)</label>
          <input type="number" class="form-control" id="tConsigne" value="19" min="15" max="25" step="1" onchange="onBuildingChange()">
        </div>
      </div>
      <div class="stat-row cols-2">
        <div class="stat-box"><div class="s-label">Deperditions</div><div class="s-value" id="rdDep">&mdash;<span class="s-unit">kW</span></div></div>
        <div class="stat-box"><div class="s-label">Dp</div><div class="s-value" id="rdDp">&mdash;<span class="s-unit">W/K</span></div></div>
      </div>
    </div>

    <!-- PAC -->
    <div class="form-section" id="sectionPAC">
      <div class="section-label"><i class="ti ti-temperature-snow"></i>Pompe a chaleur</div>
      <div class="mb-3">
        <label class="form-label">Gamme PAC</label>
        <div class="form-selectgroup w-100">
          <label class="form-selectgroup-item flex-fill">
            <input type="radio" name="gamme" value="effipac" class="form-selectgroup-input" checked onchange="onPACChange()">
            <div class="form-selectgroup-label d-flex align-items-center justify-content-center gap-2">Effipac <span class="badge bg-blue-lt">R32</span></div>
          </label>
          <label class="form-selectgroup-item flex-fill">
            <input type="radio" name="gamme" value="aptae" class="form-selectgroup-input" onchange="onPACChange()">
            <div class="form-selectgroup-label d-flex align-items-center justify-content-center gap-2">Aptae <span class="badge bg-green-lt">R290</span></div>
          </label>
        </div>
      </div>
      <div class="row g-2">
        <div class="col-7">
          <label class="form-label">T eau depart</label>
          <select class="form-select" id="tWater" onchange="onPACChange()">
            <option value="35">35&deg;C &mdash; plancher chauffant</option>
            <option value="45" selected>45&deg;C &mdash; radiateurs BT</option>
            <option value="55">55&deg;C &mdash; radiateurs HT</option>
          </select>
        </div>
        <div class="col-5">
          <label class="form-label">&Delta;T circuit</label>
          <select class="form-select" id="deltaT" onchange="onPACChange()">
            <option value="3">3 K</option>
            <option value="5" selected>5 K</option>
            <option value="8">8 K</option>
          </select>
        </div>
      </div>
    </div>

    <!-- ECS -->
    <div class="form-section" id="sectionECS" style="display:none">
      <div class="section-label"><i class="ti ti-droplet"></i>Eau Chaude Sanitaire</div>
      <div class="mb-3">
        <label class="form-label">Type batiment ECS</label>
        <select class="form-select" id="ecsType" onchange="onECSChange()">
          <option value="logements" selected>Logements collectifs</option>
          <optgroup label="Tertiaire">
            <option value="hotel_affaire">Hotel affaire</option>
            <option value="hotel_tourisme">Hotel tourisme 3-4*</option>
            <option value="ehpad">EHPAD</option>
            <option value="hopital">Hopital</option>
            <option value="maison_retraite">Maison de retraite</option>
            <option value="residence_etudiante">Residence etudiante</option>
            <option value="restaurant_collectif">Restauration collective</option>
          </optgroup>
        </select>
      </div>
      <div id="ecsLogements">
        <div class="mb-3">
          <label class="form-label">Parc</label>
          <div class="form-selectgroup w-100">
            <label class="form-selectgroup-item flex-fill">
              <input type="radio" name="parc" value="social" class="form-selectgroup-input" checked onchange="onECSChange()">
              <div class="form-selectgroup-label d-flex align-items-center justify-content-center">Social</div>
            </label>
            <label class="form-selectgroup-item flex-fill">
              <input type="radio" name="parc" value="prive" class="form-selectgroup-input" onchange="onECSChange()">
              <div class="form-selectgroup-label d-flex align-items-center justify-content-center">Prive</div>
            </label>
          </div>
        </div>
        <table class="table table-sm ecs-grid" id="ecsGrid">
          <thead><tr class="text-muted" style="font-size:.7rem"><th>Type</th><th class="text-center">Equiv. LS</th><th class="text-center" style="width:80px">Nb</th></tr></thead>
          <tbody>
            <tr><td>T1 / Studio</td><td class="text-center text-muted" id="eqT1" style="font-family:var(--mono)">0.6</td><td><input type="number" class="form-control form-control-sm" data-type="T1" value="6" min="0" max="500" onchange="onECSChange()"></td></tr>
            <tr><td>T2</td><td class="text-center text-muted" id="eqT2" style="font-family:var(--mono)">0.7</td><td><input type="number" class="form-control form-control-sm" data-type="T2" value="12" min="0" max="500" onchange="onECSChange()"></td></tr>
            <tr><td>T3</td><td class="text-center text-muted" id="eqT3" style="font-family:var(--mono)">1.0</td><td><input type="number" class="form-control form-control-sm" data-type="T3" value="20" min="0" max="500" onchange="onECSChange()"></td></tr>
            <tr><td>T4</td><td class="text-center text-muted" id="eqT4" style="font-family:var(--mono)">1.4</td><td><input type="number" class="form-control form-control-sm" data-type="T4" value="8" min="0" max="500" onchange="onECSChange()"></td></tr>
            <tr><td>T5+</td><td class="text-center text-muted" id="eqT5" style="font-family:var(--mono)">1.8</td><td><input type="number" class="form-control form-control-sm" data-type="T5" value="4" min="0" max="500" onchange="onECSChange()"></td></tr>
          </tbody>
        </table>
      </div>
      <div id="ecsTertiaire" style="display:none">
        <label class="form-label">Nombre d'unites</label>
        <input type="number" class="form-control" id="ecsUnits" value="50" min="1" max="5000" onchange="onECSChange()">
      </div>
    </div>

    <!-- HYBRID -->
    <div class="form-section" id="sectionHybrid" style="display:none">
      <div class="section-label"><i class="ti ti-flame"></i>Chaudiere d'appoint</div>
      <div class="mb-3">
        <label class="form-label">Type de chaudiere</label>
        <select class="form-select" id="boilerType"><option value="gaz_condensation">Gaz condensation (&eta;=0.95)</option><option value="gaz_standard">Gaz standard (&eta;=0.85)</option><option value="fioul">Fioul (&eta;=0.90)</option></select>
      </div>
      <div class="mb-3">
        <label class="form-label">Mode bivalent</label>
        <select class="form-select" id="bivalentMode"><option value="parallel">Bivalent parallele</option><option value="alternatif">Bivalent alternatif</option></select>
      </div>
    </div>

    <!-- CALCULATE -->
    <div class="calc-section">
      <button class="btn btn-calc w-100" onclick="calculate()" id="btnCalc">
        <i class="ti ti-calculator me-2"></i>Dimensionner
      </button>
    </div>
  </div>

  <!-- ===== RIGHT: RESULTS ===== -->
  <div class="app-col-results">
    <div class="results-empty" id="placeholder">
      <i class="ti ti-snowflake" style="font-size:48px;opacity:.15"></i>
      <p>Renseignez les parametres puis cliquez sur <strong>Dimensionner</strong> pour obtenir les solutions.</p>
    </div>
    <div id="results" style="display:none"></div>
  </div>

</div>

<!-- ===== DEVIS MODAL ===== -->
<div class="devis-overlay" id="devisOverlay">
  <div class="devis-modal">
    <div class="devis-header">
      <h3><i class="ti ti-file-text me-2"></i>Creer un devis</h3>
      <button class="devis-close" onclick="closeDevis()"><i class="ti ti-x"></i></button>
    </div>
    <div class="devis-body">
      <div class="row g-3">
        <div class="col-12"><label class="form-label">Nom du projet / Affaire</label><input type="text" class="form-control" id="dvProjet" placeholder="ex: Residence Les Cedres - Lot CVC"></div>
        <div class="col-6"><label class="form-label">Reference devis</label><input type="text" class="form-control" id="dvRef" placeholder="DEV-2024-001"></div>
        <div class="col-6"><label class="form-label">Date</label><input type="date" class="form-control" id="dvDate"></div>
        <div class="col-12"><hr class="my-2"><label class="form-label text-muted" style="font-size:.7rem;text-transform:uppercase;letter-spacing:.1em">Client</label></div>
        <div class="col-12"><label class="form-label">Societe / Bureau d'etudes</label><input type="text" class="form-control" id="dvClient" placeholder="ex: BET Thermique SARL"></div>
        <div class="col-6"><label class="form-label">Contact</label><input type="text" class="form-control" id="dvContact" placeholder="M. Dupont"></div>
        <div class="col-6"><label class="form-label">Email</label><input type="email" class="form-control" id="dvEmail" placeholder="contact@bet.fr"></div>
        <div class="col-12"><label class="form-label">Adresse chantier</label><input type="text" class="form-control" id="dvAdresse" placeholder="ex: 12 rue des Lilas, 75015 Paris"></div>
        <div class="col-12"><hr class="my-2"><label class="form-label text-muted" style="font-size:.7rem;text-transform:uppercase;letter-spacing:.1em">Options PDF</label></div>
        <div class="col-12">
          <label class="form-check form-switch mb-2"><input class="form-check-input" type="checkbox" id="dvIncludeSchemas" checked><span class="form-check-label">Inclure les schemas techniques</span></label>
          <label class="form-check form-switch mb-2"><input class="form-check-input" type="checkbox" id="dvIncludeChart" checked><span class="form-check-label">Inclure la courbe monotone</span></label>
          <label class="form-check form-switch mb-2"><input class="form-check-input" type="checkbox" id="dvIncludeComp" checked><span class="form-check-label">Inclure la comparaison concurrents</span></label>
          <label class="form-check form-switch"><input class="form-check-input" type="checkbox" id="dvIncludeECS" checked><span class="form-check-label">Inclure dimensionnement ECS</span></label>
        </div>
        <div class="col-12"><label class="form-label">Notes / Observations</label><textarea class="form-control" id="dvNotes" rows="3" placeholder="Conditions particulieres, hypotheses..."></textarea></div>
      </div>
    </div>
    <div class="devis-footer">
      <button class="btn" onclick="closeDevis()">Annuler</button>
      <button class="btn-pdf orange" onclick="generateDevisPDF()"><i class="ti ti-download"></i>Telecharger PDF</button>
    </div>
  </div>
</div>

<!-- ===== LIGHTBOX ===== -->
<div class="lightbox-overlay" id="lightbox" onclick="closeLightbox()">
  <button class="lightbox-close" onclick="closeLightbox()"><i class="ti ti-x"></i></button>
  <img id="lightboxImg" src="" alt="">
  <div class="lightbox-title" id="lightboxTitle"></div>
</div>

<!-- ===== SCRIPTS ===== -->
<script src="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta20/dist/js/tabler.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.2/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/jspdf.plugin.autotable.min.js"></script>
<script src="data/performance.js"></script>
<script src="data/schemas.js"></script>
<script src="assets/js/engine.js"></script>
<script>
// ============================================================
// STATE
// ============================================================
const S = {
  mode:'elec', dept:'75', altitude:0, bordMer:false,
  tbase:-5, zone:'D', climat:'H1c',
  buildingType:'re2020', surface:1500, tInt:19,
  deperditionsKW:0, dp:0,
  gamme:'effipac', tWater:45, deltaT:5,
  solutions:[], selectedIdx:0, ecsResult:null,
  chart:null
};

// ============================================================
// INIT
// ============================================================
(function init(){
  const ds = document.getElementById('dept');
  const depts = Object.keys(PERFORMANCE_DATA.tbase).sort((a,b)=>{
    if(a==='2A'||a==='2B'||b==='2A'||b==='2B') return a<b?-1:a>b?1:0;
    return parseInt(a)-parseInt(b);
  });
  depts.forEach(d=>{const o=document.createElement('option');o.value=d;o.textContent=d+' \u2014 '+deptName(d);if(d==='75')o.selected=true;ds.appendChild(o)});

  const bs = document.getElementById('buildingType');
  Object.entries(PERFORMANCE_DATA.buildingTypes).forEach(([k,v])=>{const o=document.createElement('option');o.value=k;o.textContent=v.label+' ('+v.description+')';if(k==='re2020')o.selected=true;bs.appendChild(o)});

  onDeptChange();
  onBuildingChange();
})();

function deptName(c){
  const N={"01":"Ain","02":"Aisne","03":"Allier","04":"Alpes-de-Hte-Provence","05":"Hautes-Alpes","06":"Alpes-Maritimes","07":"Ardeche","08":"Ardennes","09":"Ariege","10":"Aube","11":"Aude","12":"Aveyron","13":"Bouches-du-Rhone","14":"Calvados","15":"Cantal","16":"Charente","17":"Charente-Maritime","18":"Cher","19":"Correze","2A":"Corse-du-Sud","2B":"Haute-Corse","21":"Cote-d'Or","22":"Cotes-d'Armor","23":"Creuse","24":"Dordogne","25":"Doubs","26":"Drome","27":"Eure","28":"Eure-et-Loir","29":"Finistere","30":"Gard","31":"Haute-Garonne","32":"Gers","33":"Gironde","34":"Herault","35":"Ille-et-Vilaine","36":"Indre","37":"Indre-et-Loire","38":"Isere","39":"Jura","40":"Landes","41":"Loir-et-Cher","42":"Loire","43":"Haute-Loire","44":"Loire-Atlantique","45":"Loiret","46":"Lot","47":"Lot-et-Garonne","48":"Lozere","49":"Maine-et-Loire","50":"Manche","51":"Marne","52":"Haute-Marne","53":"Mayenne","54":"Meurthe-et-Moselle","55":"Meuse","56":"Morbihan","57":"Moselle","58":"Nievre","59":"Nord","60":"Oise","61":"Orne","62":"Pas-de-Calais","63":"Puy-de-Dome","64":"Pyrenees-Atlantiques","65":"Hautes-Pyrenees","66":"Pyrenees-Orientales","67":"Bas-Rhin","68":"Haut-Rhin","69":"Rhone","70":"Haute-Saone","71":"Saone-et-Loire","72":"Sarthe","73":"Savoie","74":"Haute-Savoie","75":"Paris","76":"Seine-Maritime","77":"Seine-et-Marne","78":"Yvelines","79":"Deux-Sevres","80":"Somme","81":"Tarn","82":"Tarn-et-Garonne","83":"Var","84":"Vaucluse","85":"Vendee","86":"Vienne","87":"Haute-Vienne","88":"Vosges","89":"Yonne","90":"Belfort","91":"Essonne","92":"Hauts-de-Seine","93":"Seine-St-Denis","94":"Val-de-Marne","95":"Val-d'Oise"};
  return N[c]||c;
}

// ============================================================
// EVENTS
// ============================================================
function switchMode(m){
  S.mode=m;
  document.querySelectorAll('.mode-tab').forEach(t=>t.classList.toggle('active',t.dataset.mode===m));
  document.getElementById('modeSelect').value=m;
  document.getElementById('sectionPAC').style.display=m!=='ecs'?'':'none';
  document.getElementById('sectionECS').style.display=(m==='ecs'||m==='double')?'':'none';
  document.getElementById('sectionHybrid').style.display=m==='hybrid'?'':'none';
}
function onDeptChange(){S.dept=document.getElementById('dept').value;onLocationChange()}
function onLocationChange(){
  S.altitude=parseInt(document.getElementById('altitude').value)||0;
  S.bordMer=document.getElementById('bordMer').checked;
  const d=PERFORMANCE_DATA.tbase[S.dept];
  if(d){S.tbase=SizingEngine.getTbase(S.dept,S.altitude,S.bordMer);S.zone=d.zone;S.climat=d.climat}
  document.getElementById('rdTbase').innerHTML=S.tbase+'&deg;C';
  document.getElementById('rdZone').textContent=S.zone;
  document.getElementById('rdClimat').textContent=S.climat;
  onBuildingChange();
}
function onBuildingChange(){
  S.buildingType=document.getElementById('buildingType').value;
  S.surface=parseInt(document.getElementById('surface').value)||1500;
  S.tInt=parseInt(document.getElementById('tConsigne').value)||19;
  const r=SizingEngine.calcDeperditions({surface:S.surface,buildingType:S.buildingType,tInt:S.tInt,tBase:S.tbase});
  if(r){S.deperditionsKW=r.deperditionsKW;S.dp=r.dp;
    document.getElementById('rdDep').innerHTML=r.deperditionsKW.toFixed(1)+'<span class="s-unit">kW</span>';
    document.getElementById('rdDp').innerHTML=r.dp.toFixed(1)+'<span class="s-unit">W/K</span>'}
}
function onPACChange(){
  S.gamme=document.querySelector('input[name="gamme"]:checked').value;
  S.tWater=parseInt(document.getElementById('tWater').value);
  S.deltaT=parseInt(document.getElementById('deltaT').value);
}
function onECSChange(){
  const t=document.getElementById('ecsType').value, isL=t==='logements';
  document.getElementById('ecsLogements').style.display=isL?'':'none';
  document.getElementById('ecsTertiaire').style.display=isL?'none':'';
  if(isL){const p=document.querySelector('input[name="parc"]:checked').value,c=PERFORMANCE_DATA.ecs.equivalenceParc[p];
    ['T1','T2','T3','T4','T5'].forEach(k=>document.getElementById('eq'+k).textContent=c[k])}
}

// ============================================================
// LIGHTBOX
// ============================================================
function openLightbox(src,title){
  document.getElementById('lightboxImg').src=src;
  document.getElementById('lightboxTitle').textContent=title||'';
  document.getElementById('lightbox').classList.add('open');
  document.body.style.overflow='hidden';
}
function closeLightbox(){
  document.getElementById('lightbox').classList.remove('open');
  document.body.style.overflow='';
}
document.addEventListener('keydown',e=>{if(e.key==='Escape'){closeLightbox();closeDevis()}});

// ============================================================
// DEVIS MODAL
// ============================================================
function openDevis(){
  document.getElementById('dvDate').value=new Date().toISOString().split('T')[0];
  if(!document.getElementById('dvRef').value){
    document.getElementById('dvRef').value='DEV-'+new Date().getFullYear()+'-'+String(Math.floor(Math.random()*999)+1).padStart(3,'0');
  }
  document.getElementById('devisOverlay').classList.add('open');
  document.body.style.overflow='hidden';
}
function closeDevis(){
  document.getElementById('devisOverlay').classList.remove('open');
  document.body.style.overflow='';
}

// ============================================================
// PDF GENERATION (jsPDF)
// ============================================================
function pdfColors(){return{navy:[0,51,102],orange:[232,98,42],lightBlue:[232,240,254],white:[255,255,255],gray:[107,114,128],darkText:[26,35,50],lightGray:[245,245,245]}}

function pdfHeader(doc,title,subtitle){
  const c=pdfColors(),w=doc.internal.pageSize.getWidth();
  doc.setFillColor(...c.navy);doc.rect(0,0,w,28,'F');
  doc.setFontSize(14);doc.setTextColor(...c.white);doc.text('PAC Dimensionnement',14,12);
  doc.setFontSize(8);doc.setTextColor(180,200,220);doc.text('Outil de dimensionnement PAC collectives',14,18);
  if(title){doc.setFontSize(9);doc.setTextColor(...c.orange);doc.text(title,14,25)}
  if(subtitle){doc.setTextColor(180,200,220);doc.text(subtitle,w-14,25,{align:'right'})}
  return 34;
}

function pdfFooter(doc,pageNum){
  const c=pdfColors(),w=doc.internal.pageSize.getWidth(),h=doc.internal.pageSize.getHeight();
  doc.setDrawColor(200,200,200);doc.line(14,h-16,w-14,h-16);
  doc.setFontSize(7);doc.setTextColor(...c.gray);
  doc.text('NF EN 12831 | EN 14825 | ADEME/COSTIC | Heat Pump Keymark',14,h-10);
  doc.text('Page '+pageNum,w-14,h-10,{align:'right'});
  doc.text('Document genere par PAC Dimensionnement — '+new Date().toLocaleDateString('fr-FR'),w/2,h-10,{align:'center'});
}

function pdfSection(doc,y,title){
  const c=pdfColors(),w=doc.internal.pageSize.getWidth();
  doc.setFillColor(...c.navy);doc.rect(14,y,w-28,7,'F');
  doc.setFontSize(9);doc.setTextColor(...c.white);doc.text(title,17,y+5);
  return y+10;
}

function pdfKeyValue(doc,y,label,value,highlight){
  const c=pdfColors();
  doc.setFontSize(8.5);doc.setTextColor(...c.gray);doc.text(label,16,y);
  if(highlight)doc.setTextColor(...c.orange);else doc.setTextColor(...c.darkText);
  doc.setFont(undefined,'bold');doc.text(String(value),100,y);doc.setFont(undefined,'normal');
  return y+5.5;
}

function pdfCheckPage(doc,y,margin){
  const h=doc.internal.pageSize.getHeight();
  if(y>h-margin){doc.addPage();pdfFooter(doc,doc.internal.pages.length-1);return pdfHeader(doc,'','(suite)');}
  return y;
}

function loadJsPDF(){
  return new Promise((resolve,reject)=>{
    if(window.jspdf){return resolve()}
    const s=document.createElement('script');
    s.src='https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.2/jspdf.umd.min.js';
    s.onload=()=>{
      const s2=document.createElement('script');
      s2.src='https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js';
      s2.onload=()=>resolve();
      s2.onerror=()=>reject(new Error('autoTable plugin failed'));
      document.head.appendChild(s2);
    };
    s.onerror=()=>reject(new Error('jsPDF failed to load'));
    document.head.appendChild(s);
  });
}

function openPdfPreview(doc,filename){
  try{
    const blob=doc.output('blob');
    const url=URL.createObjectURL(blob);
    const win=window.open(url,'_blank');
    if(!win){doc.save(filename)}
  }catch(e){doc.save(filename)}
}

async function generateQuickPDF(){
  if(!S.solutions||S.solutions.length===0)return alert('Calculez d\'abord une solution.');
  if(!window.jspdf){try{await loadJsPDF()}catch(e){return alert('Impossible de charger jsPDF. Verifiez votre connexion internet et rechargez la page.')}}
  if(!window.jspdf){return alert('jsPDF non disponible. Rechargez la page.')}
  try{
  const sol=S.solutions[S.selectedIdx];
  const {jsPDF}=window.jspdf;
  const doc=new jsPDF({unit:'mm',format:'a4'});
  const w=doc.internal.pageSize.getWidth();
  let y=pdfHeader(doc,'Fiche technique','Genere le '+new Date().toLocaleDateString('fr-FR'));
  let page=1;

  // Donnees projet
  y=pdfSection(doc,y,'DONNEES CLIMATIQUES & BATIMENT');
  y=pdfKeyValue(doc,y,'Departement',S.dept+' — '+deptName(S.dept));
  y=pdfKeyValue(doc,y,'Altitude',S.altitude+' m');
  y=pdfKeyValue(doc,y,'Tbase',S.tbase+' °C',true);
  y=pdfKeyValue(doc,y,'Zone climatique',S.climat);
  y=pdfKeyValue(doc,y,'Type batiment',document.getElementById('buildingType').selectedOptions[0].textContent);
  y=pdfKeyValue(doc,y,'Surface',S.surface+' m²');
  y=pdfKeyValue(doc,y,'T° consigne',S.tInt+' °C');
  y=pdfKeyValue(doc,y,'Deperditions',S.deperditionsKW.toFixed(1)+' kW',true);
  y+=4;

  // PAC selection
  y=pdfSection(doc,y,'SOLUTION PAC SELECTIONNEE');
  y=pdfKeyValue(doc,y,'Gamme',sol.pac.refrigerant==='R290'?'Aptae (R290)':'Effipac (R32)');
  y=pdfKeyValue(doc,y,'Modele',sol.pac.nom);
  y=pdfKeyValue(doc,y,'Nombre d\'unites',sol.nombre);
  y=pdfKeyValue(doc,y,'P. nominale totale',sol.puissance_totale_nom.toFixed(1)+' kW',true);
  y=pdfKeyValue(doc,y,'P. a Tbase ('+S.tbase+'°C)',sol.puissance_totale_tbase.toFixed(1)+' kW',true);
  y=pdfKeyValue(doc,y,'Part PAC a Tbase',sol.part_pac.toFixed(1)+' %',true);

  const en=SizingEngine.calcAnnualEnergy({deperditionsKW:S.deperditionsKW,dp:S.dp,tInt:S.tInt,tBase:S.tbase,
    model:sol.pac,nombre:sol.nombre,tWater:S.tWater,climat:S.climat,mode:S.mode==='hybrid'?'hybrid':'elec'});
  y=pdfKeyValue(doc,y,'Taux couverture annuel',en.tauxCouverture.toFixed(1)+' %',true);
  y=pdfKeyValue(doc,y,'SCOP pondere',en.scopWeighted.toFixed(2));
  y=pdfKeyValue(doc,y,'Energie PAC annuelle',(en.ePac/1000).toFixed(0)+' MWh');
  y=pdfKeyValue(doc,y,'Energie appoint',(en.eBackup/1000).toFixed(0)+' MWh');
  y=pdfKeyValue(doc,y,'Conso elec PAC',(en.elecPac/1000).toFixed(0)+' MWh');
  y=pdfKeyValue(doc,y,'P. elec absorbee max',sol.pabs_tbase.toFixed(1)+' kW');
  y=pdfKeyValue(doc,y,'Intensite max (400V tri)',(sol.pabs_tbase*1000/(400*1.732)).toFixed(1)+' A');
  y=pdfKeyValue(doc,y,'T° eau depart',S.tWater+' °C');
  y=pdfKeyValue(doc,y,'Delta T',S.deltaT+' K');
  y+=4;

  // Hydraulique
  const hy=SizingEngine.calcHydraulics(sol.puissance_totale_nom,S.deltaT);
  y=pdfCheckPage(doc,y,60);
  y=pdfSection(doc,y,'DIMENSIONNEMENT HYDRAULIQUE');
  y=pdfKeyValue(doc,y,'Debit primaire',hy.debit_m3h.toFixed(2)+' m³/h ('+hy.debit_Lh+' L/h)');
  y=pdfKeyValue(doc,y,'Diametre raccordement','Ø'+hy.diametre_int+'/'+hy.diametre_ext+' mm');
  y=pdfKeyValue(doc,y,'Bouteille decouplage','Ø'+hy.diametre_bouteille+' mm');
  y=pdfKeyValue(doc,y,'Ballon tampon',hy.ballon_tampon_L+' L',true);
  y+=4;

  // Chart as image
  if(S.chart){
    y=pdfCheckPage(doc,y,90);
    y=pdfSection(doc,y,'COURBE MONOTONE DE CHAUFFAGE');
    try{
      const chartImg=S.chart.getDataURL({type:'png',pixelRatio:2,backgroundColor:'#fff'});
      doc.addImage(chartImg,'PNG',14,y,w-28,70);y+=74;
    }catch(e){y+=4}
  }

  // Competitor comparison
  y=pdfCheckPage(doc,y,50);
  y=pdfSection(doc,y,'COMPARAISON CONCURRENTS');
  const cs=SizingEngine.compareWithCompetitors(sol,S.deperditionsKW,S.tbase,S.tWater);
  doc.autoTable({
    startY:y,margin:{left:14,right:14},
    head:[['Marque','Modele','Qty','P.nom (kW)','Refrig.','COP','Part PAC','Prix HT']],
    body:cs.map(c=>[c.brand,c.model,c.nombre,c.puissance_nom.toFixed(1),c.refrigerant,c.cop_a7?c.cop_a7.toFixed(2):'-',c.part_pac.toFixed(1)+'%',c.prix_ht?c.prix_ht.toLocaleString('fr-FR')+' €':'-']),
    headStyles:{fillColor:[0,51,102],fontSize:7.5,cellPadding:2},
    bodyStyles:{fontSize:7.5,cellPadding:2},
    alternateRowStyles:{fillColor:[245,245,245]},
    didParseCell:function(data){if(data.section==='body'){const r=cs[data.row.index];if(r&&r.isAtlantic){data.cell.styles.fillColor=[255,243,230];data.cell.styles.fontStyle='bold'}}}
  });

  pdfFooter(doc,page);
  openPdfPreview(doc,'PAC_Dimensionnement_'+sol.pac.nom.replace(/\s/g,'_')+'x'+sol.nombre+'.pdf');
  }catch(e){alert('Erreur generation PDF: '+e.message);console.error('PDF error:',e)}
}

// ============================================================
// DEVIS PDF (complet avec infos client)
// ============================================================
async function generateDevisPDF(){
  if(!S.solutions||S.solutions.length===0)return alert('Calculez d\'abord une solution.');
  if(!window.jspdf){try{await loadJsPDF()}catch(e){return alert('Impossible de charger jsPDF.')}}
  if(!window.jspdf){return alert('jsPDF non disponible.')}
  try{
  const sol=S.solutions[S.selectedIdx];
  const {jsPDF}=window.jspdf;
  const doc=new jsPDF({unit:'mm',format:'a4'});
  const w=doc.internal.pageSize.getWidth(),h=doc.internal.pageSize.getHeight();
  const c=pdfColors();
  let page=1;

  // Get form values
  const projet=document.getElementById('dvProjet').value||'Projet PAC collective';
  const ref=document.getElementById('dvRef').value||'DEV-'+Date.now();
  const date=document.getElementById('dvDate').value||new Date().toISOString().split('T')[0];
  const client=document.getElementById('dvClient').value||'';
  const contact=document.getElementById('dvContact').value||'';
  const email=document.getElementById('dvEmail').value||'';
  const adresse=document.getElementById('dvAdresse').value||'';
  const notes=document.getElementById('dvNotes').value||'';
  const inclSchemas=document.getElementById('dvIncludeSchemas').checked;
  const inclChart=document.getElementById('dvIncludeChart').checked;
  const inclComp=document.getElementById('dvIncludeComp').checked;
  const inclECS=document.getElementById('dvIncludeECS').checked;

  // ======== PAGE 1: COVER ========
  // Full navy header
  doc.setFillColor(...c.navy);doc.rect(0,0,w,50,'F');
  doc.setFontSize(20);doc.setTextColor(...c.white);doc.text('DEVIS TECHNIQUE',14,22);
  doc.setFontSize(10);doc.text('Dimensionnement PAC collective',14,30);
  doc.setFontSize(8);doc.setTextColor(180,200,220);doc.text('PAC Dimensionnement — Atlantic Effipac / Aptae',14,38);

  // Orange accent bar
  doc.setFillColor(...c.orange);doc.rect(0,50,w,3,'F');

  // Reference & date
  let y=62;
  doc.setFillColor(...c.lightBlue);doc.roundedRect(14,y-4,w-28,20,3,3,'F');
  doc.setFontSize(9);doc.setTextColor(...c.navy);
  doc.setFont(undefined,'bold');doc.text('Reference:',16,y+2);doc.text('Date:',16,y+8);doc.text('Projet:',16,y+14);
  doc.setFont(undefined,'normal');doc.setTextColor(...c.darkText);
  doc.text(ref,50,y+2);doc.text(new Date(date).toLocaleDateString('fr-FR'),50,y+8);doc.text(projet,50,y+14);
  y+=24;

  // Client info
  if(client||contact||adresse){
    y=pdfSection(doc,y,'INFORMATIONS CLIENT');
    if(client)y=pdfKeyValue(doc,y,'Societe / BET',client);
    if(contact)y=pdfKeyValue(doc,y,'Contact',contact);
    if(email)y=pdfKeyValue(doc,y,'Email',email);
    if(adresse)y=pdfKeyValue(doc,y,'Adresse chantier',adresse);
    y+=4;
  }

  // Donnees du batiment
  y=pdfSection(doc,y,'DONNEES DU BATIMENT');
  y=pdfKeyValue(doc,y,'Departement',S.dept+' — '+deptName(S.dept));
  y=pdfKeyValue(doc,y,'Altitude',S.altitude+' m'+(S.bordMer?' (bord de mer)':''));
  y=pdfKeyValue(doc,y,'Tbase',S.tbase+' °C',true);
  y=pdfKeyValue(doc,y,'Zone climatique',S.climat+' / Zone '+S.zone);
  y=pdfKeyValue(doc,y,'Type batiment',document.getElementById('buildingType').selectedOptions[0].textContent);
  y=pdfKeyValue(doc,y,'Surface habitable',S.surface+' m²');
  y=pdfKeyValue(doc,y,'T° consigne interieure',S.tInt+' °C');
  y=pdfKeyValue(doc,y,'Deperditions totales',S.deperditionsKW.toFixed(1)+' kW',true);
  y=pdfKeyValue(doc,y,'Dp (W/K)',S.dp.toFixed(1)+' W/K');
  y+=4;

  // Mode
  const modeLabels={elec:'Chauffage 100% Electrique',double:'Double Service (Chauffage + ECS)',ecs:'ECS Seul',hybrid:'Chauffage Hybride'};
  y=pdfKeyValue(doc,y,'Mode de fonctionnement',modeLabels[S.mode]||S.mode);
  y+=2;

  // Solution PAC
  y=pdfCheckPage(doc,y,70);
  y=pdfSection(doc,y,'SOLUTION PAC PRECONISEE');

  const en=SizingEngine.calcAnnualEnergy({deperditionsKW:S.deperditionsKW,dp:S.dp,tInt:S.tInt,tBase:S.tbase,
    model:sol.pac,nombre:sol.nombre,tWater:S.tWater,climat:S.climat,mode:S.mode==='hybrid'?'hybrid':'elec'});

  // PAC details table
  doc.autoTable({
    startY:y,margin:{left:14,right:14},
    head:[['Caracteristique','Valeur']],
    body:[
      ['Gamme',sol.pac.refrigerant==='R290'?'Atlantic Aptae (R290)':'Atlantic Effipac (R32)'],
      ['Modele',sol.pac.nom],
      ['Code',sol.pac.code],
      ['Nombre d\'unites',String(sol.nombre)+(sol.nombre>1?' (cascade)':'')],
      ['Chassis',sol.pac.chassis],
      ['Refrigerant',sol.pac.refrigerant],
      ['T° max eau',sol.pac.t_max+' °C'],
      ['T° eau depart projet',S.tWater+' °C'],
      ['Delta T circuit',S.deltaT+' K'],
      ['',''],
      ['Puissance nominale totale',sol.puissance_totale_nom.toFixed(1)+' kW'],
      ['Puissance a Tbase ('+S.tbase+'°C)',sol.puissance_totale_tbase.toFixed(1)+' kW'],
      ['Part PAC a Tbase',sol.part_pac.toFixed(1)+' %'],
      ['Taux de couverture annuel',en.tauxCouverture.toFixed(1)+' %'],
      ['SCOP pondere',en.scopWeighted.toFixed(2)],
      ['',''],
      ['Energie PAC annuelle',(en.ePac/1000).toFixed(1)+' MWh'],
      ['Energie appoint electrique',(en.eBackup/1000).toFixed(1)+' MWh'],
      ['Consommation elec PAC',(en.elecPac/1000).toFixed(1)+' MWh'],
      ['P. electrique absorbee max',sol.pabs_tbase.toFixed(1)+' kW'],
      ['Intensite max (400V tri)',(sol.pabs_tbase*1000/(400*1.732)).toFixed(1)+' A'],
      ['',''],
      ['Reference catalogue',sol.pac.ref||'-'],
      ['Prix unitaire HT',sol.pac.prix_ht?sol.pac.prix_ht.toLocaleString('fr-FR')+' € HT':'-'],
      ['Prix total PAC (x'+sol.nombre+')',sol.pac.prix_ht?(sol.pac.prix_ht*sol.nombre).toLocaleString('fr-FR')+' € HT':'-'],
    ],
    headStyles:{fillColor:[0,51,102],fontSize:8,cellPadding:3},
    bodyStyles:{fontSize:8,cellPadding:2.5},
    columnStyles:{0:{fontStyle:'bold',cellWidth:75},1:{halign:'right'}},
    alternateRowStyles:{fillColor:[248,250,252]},
    didParseCell:function(data){
      if(data.section==='body'){
        const key=data.row.cells[0]?.text?.[0]||'';
        if(['Part PAC','Taux de couverture','Puissance nominale'].some(k=>key.includes(k))){
          data.cell.styles.textColor=[232,98,42];data.cell.styles.fontStyle='bold'}
        if(data.row.cells[0]?.text?.[0]==='')data.cell.styles.fillColor=[255,255,255];
      }
    }
  });
  y=doc.lastAutoTable.finalY+6;

  // Hydraulique
  y=pdfCheckPage(doc,y,50);
  const hy=SizingEngine.calcHydraulics(sol.puissance_totale_nom,S.deltaT);
  y=pdfSection(doc,y,'DIMENSIONNEMENT HYDRAULIQUE');
  doc.autoTable({
    startY:y,margin:{left:14,right:14},
    body:[
      ['Debit primaire',hy.debit_m3h.toFixed(2)+' m³/h ('+hy.debit_Lh+' L/h)'],
      ['Delta T',hy.deltaT+' K'],
      ['Diametre raccordement','Ø'+hy.diametre_int+'/'+hy.diametre_ext+' mm'],
      ['Bouteille decouplage','Ø'+hy.diametre_bouteille+' mm'],
      ['Ballon tampon recommande',hy.ballon_tampon_L+' L'],
    ],
    bodyStyles:{fontSize:8,cellPadding:2.5},
    columnStyles:{0:{fontStyle:'bold',cellWidth:75},1:{halign:'right'}},
    alternateRowStyles:{fillColor:[248,250,252]}
  });
  y=doc.lastAutoTable.finalY+6;

  // Bivalent point for hybrid
  if(S.mode==='hybrid'){
    const biv=SizingEngine.calcBivalentPoint({deperditionsKW:S.deperditionsKW,dp:S.dp,tInt:S.tInt,tBase:S.tbase,model:sol.pac,nombre:sol.nombre,tWater:S.tWater});
    if(biv){
      y=pdfCheckPage(doc,y,30);
      y=pdfSection(doc,y,'POINT DE BIVALENCE');
      y=pdfKeyValue(doc,y,'Temperature bivalence',biv.tBivalent.toFixed(1)+' °C',true);
      y=pdfKeyValue(doc,y,'Charge au point bivalent',biv.loadAtBivalent.toFixed(1)+' kW');
      y=pdfKeyValue(doc,y,'Capacite PAC au point bivalent',biv.capacityAtBivalent.toFixed(1)+' kW');
      y+=6;
    }
  }

  // ======== PAGE 2: Chart + Comparison ========
  if(inclChart&&S.chart){
    doc.addPage();page++;
    y=pdfHeader(doc,'Courbe monotone','Page '+page);
    y=pdfSection(doc,y,'COURBE MONOTONE DE CHAUFFAGE');
    try{
      const chartImg=S.chart.getDataURL({type:'png',pixelRatio:2,backgroundColor:'#fff'});
      doc.addImage(chartImg,'PNG',14,y,w-28,80);y+=84;
    }catch(e){y+=4}

    // Energy summary
    y=pdfSection(doc,y,'BILAN ENERGETIQUE ANNUEL');
    doc.autoTable({
      startY:y,margin:{left:14,right:14},
      body:[
        ['Energie totale chauffage',(en.eTotal/1000).toFixed(1)+' MWh/an'],
        ['Couvert par PAC',(en.ePac/1000).toFixed(1)+' MWh/an ('+en.tauxCouverture.toFixed(1)+'%)'],
        ['Appoint electrique',(en.eBackup/1000).toFixed(1)+' MWh/an'],
        ['Consommation elec PAC',(en.elecPac/1000).toFixed(1)+' MWh/an'],
        ['SCOP pondere',en.scopWeighted.toFixed(2)],
      ],
      bodyStyles:{fontSize:8.5,cellPadding:3},
      columnStyles:{0:{fontStyle:'bold',cellWidth:80},1:{halign:'right'}},
      alternateRowStyles:{fillColor:[248,250,252]}
    });
    y=doc.lastAutoTable.finalY+6;
  }

  // Comparison
  if(inclComp){
    y=pdfCheckPage(doc,y,50);
    y=pdfSection(doc,y,'COMPARAISON CONCURRENTS');
    const cs=SizingEngine.compareWithCompetitors(sol,S.deperditionsKW,S.tbase,S.tWater);
    doc.autoTable({
      startY:y,margin:{left:14,right:14},
      head:[['Marque','Modele','Qty','P.nom (kW)','Refrig.','COP A7','Part PAC','Prix HT']],
      body:cs.map(cc=>[cc.brand,cc.model,cc.nombre,cc.puissance_nom.toFixed(1),cc.refrigerant,cc.cop_a7?cc.cop_a7.toFixed(2):'-',cc.part_pac.toFixed(1)+'%',cc.prix_ht?cc.prix_ht.toLocaleString('fr-FR')+' €':'-']),
      headStyles:{fillColor:[0,51,102],fontSize:7.5,cellPadding:2},
      bodyStyles:{fontSize:7.5,cellPadding:2},
      alternateRowStyles:{fillColor:[245,245,245]},
      didParseCell:function(data){if(data.section==='body'){const r=cs[data.row.index];if(r&&r.isAtlantic){data.cell.styles.fillColor=[255,243,230];data.cell.styles.fontStyle='bold'}}}
    });
    y=doc.lastAutoTable.finalY+6;
  }

  // Notes
  if(notes){
    y=pdfCheckPage(doc,y,30);
    y=pdfSection(doc,y,'NOTES & OBSERVATIONS');
    doc.setFontSize(8);doc.setTextColor(...c.darkText);
    const lines=doc.splitTextToSize(notes,w-28);
    doc.text(lines,14,y);y+=lines.length*4+6;
  }

  // Conditions
  y=pdfCheckPage(doc,y,40);
  y=pdfSection(doc,y,'CONDITIONS & REFERENCES');
  doc.setFontSize(7);doc.setTextColor(...c.gray);
  const conditions=[
    'Ce document est un dimensionnement indicatif. Il ne remplace pas une etude thermique detaillee (NF EN 12831).',
    'Les performances PAC sont issues des fiches techniques Atlantic / certifications Heat Pump Keymark.',
    'Le SCOP est calcule par methode des bins (EN 14825) avec les donnees climatiques departementales.',
    'Les debits et diametres sont donnes a titre indicatif. Verifier les pertes de charge reelles.',
    'Normes: NF EN 12831, EN 14825, ADEME/COSTIC (ECS), RE2020, NF DTU 65.16.',
  ];
  conditions.forEach(txt=>{doc.text('• '+txt,16,y);y+=4});

  // Add footers to all pages
  const totalPages=doc.internal.pages.length-1;
  for(let p=1;p<=totalPages;p++){doc.setPage(p);pdfFooter(doc,p)}

  openPdfPreview(doc,'Devis_'+ref.replace(/[^a-zA-Z0-9-]/g,'_')+'.pdf');
  closeDevis();
  }catch(e){alert('Erreur generation devis PDF: '+e.message);console.error('Devis PDF error:',e)}
}

// ============================================================
// HELPERS
// ============================================================
function fmtPrice(v){return v?new Intl.NumberFormat('fr-FR',{style:'currency',currency:'EUR',minimumFractionDigits:0,maximumFractionDigits:0}).format(v):'\u2014'}

function backToInputs(){
  document.querySelector('.app-main').classList.remove('has-results');
  window.scrollTo({top:0,behavior:'smooth'});
}

// Collapsible cards (delegate)
document.addEventListener('click',function(e){
  const head=e.target.closest('.res-card-head');
  if(head&&head.querySelector('.chevron')){head.closest('.res-card').classList.toggle('collapsed')}
});

// ============================================================
// CALCULATE
// ============================================================
function calculate(){
  const btn=document.getElementById('btnCalc');
  btn.innerHTML='<span class="spinner-border spinner-border-sm me-2"></span>Calcul...';
  btn.disabled=true;
  setTimeout(()=>{try{doCalc()}finally{btn.innerHTML='<i class="ti ti-calculator me-2"></i>Dimensionner';btn.disabled=false}},50);
}
function doCalc(){
  let html='';
  if(S.mode==='ecs'){html=calcECS()}
  else{
    const sols=SizingEngine.selectPAC({deperditionsKW:S.deperditionsKW,gamme:S.gamme,tWater:S.tWater,
      mode:S.mode==='hybrid'?'hybrid':'elec',tBase:S.tbase,tInt:S.tInt});
    S.solutions=sols;S.selectedIdx=0;
    html=sols.length===0?'<div class="results-empty"><p>Aucune solution trouvee. Modifiez la gamme ou la surface.</p></div>':renderSolutions(sols);
  }
  document.getElementById('placeholder').style.display='none';
  const r=document.getElementById('results');r.style.display='';r.innerHTML=html;
  if(S.mode!=='ecs'&&S.solutions.length>0)selectSol(0);
  // Mobile: hide inputs, show back button, scroll to top
  if(window.innerWidth<992){
    document.querySelector('.app-main').classList.add('has-results');
    window.scrollTo({top:0,behavior:'smooth'});
  }
}

// ============================================================
// RENDER SOLUTIONS
// ============================================================
function renderSolutions(sols){
  let h='<button class="btn-back-mobile" onclick="backToInputs()"><i class="ti ti-arrow-left"></i>Modifier les parametres</button>';

  // Solution selector + inline actions
  h+='<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap;gap:6px">';
  h+='<div style="font-size:.75rem;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--atlantic)">'+sols.length+' solution'+(sols.length>1?'s':'')+' trouvee'+(sols.length>1?'s':'')+'</div>';
  h+='<div class="pdf-actions">';
  h+='<button class="btn-pdf" onclick="generateQuickPDF()"><i class="ti ti-file-type-pdf"></i>PDF</button>';
  h+='<button class="btn-pdf orange" onclick="openDevis()"><i class="ti ti-file-invoice"></i>Devis</button>';
  h+='<button class="btn-pdf teal" onclick="window.print()"><i class="ti ti-printer"></i>Imprimer</button>';
  h+='</div></div>';

  h+='<div class="sol-grid">';
  sols.forEach((s,i)=>{
    const ok=s.taux_couverture>=90,w=s.taux_couverture>=70&&s.taux_couverture<90;
    h+=`<div class="sol-card anim" onclick="selectSol(${i})" id="card${i}">
      <div class="d-flex justify-content-between align-items-start mb-1">
        <div><div class="sol-name">${s.pac.nom}</div><div class="sol-sub">${s.nombre>1?s.nombre+' unites cascade':'1 unite'} &bull; ${s.pac.refrigerant}</div></div>
        ${ok?'<span class="badge bg-green-lt" style="font-size:.65rem">&#10003; Optimal</span>':w?'<span class="badge bg-yellow-lt" style="font-size:.65rem">Partiel</span>':''}
      </div>
      <div class="sol-metrics">
        <div class="sol-metric"><div class="sm-label">P. totale</div><div class="sm-value">${s.puissance_totale_nom.toFixed(1)}<span class="sm-unit"> kW</span></div></div>
        <div class="sol-metric"><div class="sm-label">Part PAC</div><div class="sm-value ${ok?'good':w?'warn':''}">${s.part_pac.toFixed(1)}<span class="sm-unit"> %</span></div></div>
        <div class="sol-metric"><div class="sm-label">Couverture</div><div class="sm-value ${ok?'good':w?'warn':''}">${s.taux_couverture.toFixed(1)}<span class="sm-unit"> %</span></div></div>
        <div class="sol-metric"><div class="sm-label">Budget PAC</div><div class="sm-value">${s.pac.prix_ht?fmtPrice(s.pac.prix_ht*s.nombre):'\u2014'}</div></div>
      </div>
    </div>`;
  });
  h+='</div>';

  // Detail area FIRST, then chart and comparison below
  h+='<div id="detailArea"></div>';
  h+='<div id="schemaArea"></div>';
  h+='<div class="res-card anim"><div class="res-card-head"><span class="bar" style="background:#3b82f6"></span>Courbe monotone de chauffage<i class="ti ti-chevron-down chevron"></i></div><div class="res-card-body padded"><div id="monotoneChart" class="chart-box"></div></div></div>';
  h+='<div id="compArea"></div>';
  return h;
}

// ============================================================
// SELECT SOLUTION
// ============================================================
function selectSol(i){
  S.selectedIdx=i;const sol=S.solutions[i];if(!sol)return;
  // Clear all active states, then set only the selected one
  document.querySelectorAll('.sol-card').forEach(c=>c.classList.remove('active'));
  const activeCard=document.getElementById('card'+i);
  if(activeCard)activeCard.classList.add('active');

  const en=SizingEngine.calcAnnualEnergy({deperditionsKW:S.deperditionsKW,dp:S.dp,tInt:S.tInt,tBase:S.tbase,
    model:sol.pac,nombre:sol.nombre,tWater:S.tWater,climat:S.climat,mode:S.mode==='hybrid'?'hybrid':'elec'});
  const hy=SizingEngine.calcHydraulics(sol.puissance_totale_nom,S.deltaT);
  let biv=null;
  if(S.mode==='hybrid')biv=SizingEngine.calcBivalentPoint({deperditionsKW:S.deperditionsKW,dp:S.dp,tInt:S.tInt,tBase:S.tbase,model:sol.pac,nombre:sol.nombre,tWater:S.tWater});

  let d=`<div class="res-card anim"><div class="res-card-head"><span class="bar" style="background:#e8622a"></span>Resultats &mdash; ${sol.pac.nom} &times;${sol.nombre}<i class="ti ti-chevron-down chevron"></i></div>
    <div class="res-card-body"><div class="table-responsive"><table class="table table-striped mb-0"><tbody>
      <tr><td>Puissance calorifique nominale</td><td>${sol.puissance_totale_nom.toFixed(1)} kW</td></tr>
      <tr><td>Puissance a Tbase (${S.tbase}&deg;C)</td><td>${sol.puissance_totale_tbase.toFixed(1)} kW</td></tr>
      <tr><td>Part PAC a Tbase</td><td class="hl">${sol.part_pac.toFixed(1)} %</td></tr>
      <tr><td>Taux de couverture annuel</td><td class="hl">${en.tauxCouverture.toFixed(1)} %</td></tr>
      <tr><td>SCOP pondere</td><td>${en.scopWeighted.toFixed(2)}</td></tr>
      <tr><td>Energie PAC annuelle</td><td>${(en.ePac/1000).toFixed(0)} MWh</td></tr>
      <tr><td>Energie appoint</td><td>${(en.eBackup/1000).toFixed(0)} MWh</td></tr>
      <tr><td>Consommation elec PAC</td><td>${(en.elecPac/1000).toFixed(0)} MWh</td></tr>
      <tr><td>P. electrique absorbee max</td><td>${sol.pabs_tbase.toFixed(1)} kW</td></tr>
      <tr><td>Intensite max (400V tri)</td><td>${(sol.pabs_tbase*1000/(400*1.732)).toFixed(1)} A</td></tr>
      ${biv?`<tr><td>Point de bivalence</td><td class="hl">${biv.tBivalent.toFixed(1)}&deg;C</td></tr>`:''}
    </tbody></table></div></div></div>`;

  // Pricing card
  try{
  if(sol.pac.prix_ht){
    const gammeData=S.gamme==='aptae'?PERFORMANCE_DATA.aptae:PERFORMANCE_DATA.effipac;
    const regul=gammeData&&gammeData.regulation?gammeData.regulation:{};
    const mes=gammeData&&gammeData.mise_en_service?gammeData.mise_en_service:{premiere:{prix_ht:0},supplementaire:{prix_ht:0}};
    const acces=PERFORMANCE_DATA.accessoires||{};
    const chassis=sol.pac.chassis||'S';
    const prixPAC=sol.pac.prix_ht*sol.nombre;
    const prixRegul=regul.navistem_t3100?regul.navistem_t3100.prix_ht:0;
    const prixMES=mes.premiere?mes.premiere.prix_ht+(sol.nombre>1?(sol.nombre-1)*(mes.supplementaire?mes.supplementaire.prix_ht:0):0):0;
    const av=acces.supports_antivibratiles||{};
    const prixAntivib=av[chassis]?av[chassis].prix_ht*sol.nombre:0;
    const totalHT=prixPAC+prixRegul+prixMES+prixAntivib;

    d+=`<div class="res-card anim"><div class="res-card-head"><span class="bar" style="background:#16a34a"></span>Estimation tarifaire HT (catalogue 02/2025)<i class="ti ti-chevron-down chevron"></i></div>
      <div class="res-card-body"><table class="table table-striped mb-0"><tbody>
        <tr><td>${sol.pac.nom} &times; ${sol.nombre}${sol.pac.ref?' (ref. '+sol.pac.ref+')':''}</td><td class="hl">${fmtPrice(prixPAC)}</td></tr>
        ${sol.pac.prix_ht_ac?`<tr class="text-muted"><td>&nbsp;&nbsp;&nbsp;Option anticorrosion${sol.pac.ref_ac?' (ref. '+sol.pac.ref_ac+')':''}</td><td>${fmtPrice(sol.pac.prix_ht_ac*sol.nombre)}</td></tr>`:''}
        ${prixRegul?`<tr><td>Regulation Navistem T3100${regul.navistem_t3100&&regul.navistem_t3100.ref?' (ref. '+regul.navistem_t3100.ref+')':''}</td><td>${fmtPrice(prixRegul)}</td></tr>`:''}
        ${prixMES?`<tr><td>Mise en service (${sol.nombre>1?'1 + '+(sol.nombre-1)+' suppl.':'1 PAC'})</td><td>${fmtPrice(prixMES)}</td></tr>`:''}
        ${prixAntivib?`<tr><td>Supports antivibratiles ${chassis} &times; ${sol.nombre}</td><td>${fmtPrice(prixAntivib)}</td></tr>`:''}
        <tr style="border-top:2px solid var(--atlantic)"><td><strong>TOTAL HT (hors options)</strong></td><td class="hl" style="font-size:1.1rem"><strong>${fmtPrice(totalHT)}</strong></td></tr>
      </tbody></table>
      <div class="p-3" style="font-size:.75rem;color:#9ca3af">Tarifs catalogue Atlantic Systemes au 1er fevrier 2025. Hors eco-participation, hors pose.</div>
      </div></div>`;
  }
  }catch(e){console.warn('Pricing card error:',e)}

  d+=`<div class="res-card anim"><div class="res-card-head"><span class="bar" style="background:#0891b2"></span>Hydraulique<i class="ti ti-chevron-down chevron"></i></div>
    <div class="res-card-body"><div class="table-responsive"><table class="table table-striped mb-0"><tbody>
      <tr><td>Debit primaire</td><td>${hy.debit_m3h.toFixed(2)} m&sup3;/h (${hy.debit_Lh} L/h)</td></tr>
      <tr><td>&Delta;T</td><td>${hy.deltaT} K</td></tr>
      <tr><td>Diametre raccordement</td><td>&empty;${hy.diametre_int}/${hy.diametre_ext} mm</td></tr>
      <tr><td>Bouteille decouplage</td><td>&empty;${hy.diametre_bouteille} mm</td></tr>
      <tr><td>Ballon tampon</td><td class="hl">${hy.ballon_tampon_L} L</td></tr>
    </tbody></table></div></div></div>`;

  document.getElementById('detailArea').innerHTML=d;

  // Schemas
  renderSchemas(sol);
  // Chart
  renderChart(sol,en);
  // Competitors
  renderComp(sol);

  // Auto-scroll to detail area so user sees the results immediately
  setTimeout(()=>{
    const da=document.getElementById('detailArea');
    if(da){
      const container=da.closest('.app-col-results');
      if(container&&window.innerWidth>=992){
        // Desktop: scroll within the results column
        da.scrollIntoView({behavior:'smooth',block:'start'});
      }
    }
  },100);
}

// ============================================================
// SCHEMAS
// ============================================================
function renderSchemas(sol){
  const imgs=SCHEMA_CATALOG.getImagesForSolution(sol.pac,S.mode,sol.nombre);
  const items=[];
  if(imgs.photo)items.push({src:imgs.photo,label:'Photo produit'});
  if(imgs.dimensions)items.push({src:imgs.dimensions,label:'Plan d\'encombrement'});
  if(imgs.degagements)items.push({src:imgs.degagements,label:'Degagements techniques'});
  if(imgs.hydraulic)items.push({src:imgs.hydraulic,label:'Schema hydraulique'});

  if(items.length===0){document.getElementById('schemaArea').innerHTML='';return}

  let h=`<div class="res-card anim"><div class="res-card-head"><span class="bar" style="background:#8b5cf6"></span>Schemas &amp; documentation<i class="ti ti-chevron-down chevron"></i></div>
    <div class="res-card-body padded"><div class="schema-grid">`;
  items.forEach(it=>{
    const safeLabel=it.label.replace(/'/g,"\\'");
    h+=`<div class="schema-thumb" onclick="openLightbox('${it.src}','${safeLabel}')">
      <img src="${it.src}" alt="${it.label}" loading="lazy">
      <div class="st-label">${it.label}</div>
    </div>`;
  });
  h+='</div></div></div>';
  document.getElementById('schemaArea').innerHTML=h;
}

// ============================================================
// ECHARTS
// ============================================================
function renderChart(sol,en){
  const el=document.getElementById('monotoneChart');if(!el)return;
  if(S.chart){S.chart.dispose();S.chart=null}
  const data=SizingEngine.generateMonotoneData({deperditionsKW:S.deperditionsKW,dp:S.dp,tInt:S.tInt,tBase:S.tbase,climat:S.climat,model:sol.pac,nombre:sol.nombre,tWater:S.tWater});
  const hrs=data.map(d=>d.hours),lds=data.map(d=>d.load),pcs=data.map(d=>d.pacCapacity);

  S.chart=echarts.init(el);
  S.chart.setOption({
    tooltip:{trigger:'axis',backgroundColor:'#fff',borderColor:'#e5e7eb',borderWidth:1,textStyle:{color:'#1a2332',fontSize:13},
      formatter:p=>'<b>'+p[0].axisValueLabel+' h</b><br/>'+p.map(x=>'<span style="display:inline-block;width:8px;height:8px;border-radius:2px;background:'+x.color+';margin-right:5px"></span>'+x.seriesName+': <b>'+x.value.toFixed(1)+' kW</b>').join('<br/>')},
    legend:{data:['Besoin chauffage','Capacite PAC'],bottom:0,left:'center',textStyle:{fontSize:12,color:'#6b7280'},itemGap:24},
    grid:{top:24,right:24,bottom:60,left:65,containLabel:false},
    xAxis:{type:'category',data:hrs,name:'Heures cumulees',nameLocation:'center',nameGap:32,
      nameTextStyle:{fontSize:12,color:'#6b7280',fontWeight:'bold'},
      axisLabel:{fontSize:10,color:'#9ca3af',fontFamily:'DM Mono',margin:10,
        formatter:(v,i)=>i%Math.ceil(hrs.length/7)===0?v:''},
      axisLine:{lineStyle:{color:'#e5e7eb'}},axisTick:{show:false}},
    yAxis:{type:'value',name:'Puissance (kW)',nameTextStyle:{fontSize:12,color:'#6b7280',fontWeight:'bold',padding:[0,0,0,0]},
      nameGap:12,
      axisLabel:{fontSize:10,color:'#9ca3af',fontFamily:'DM Mono',margin:8},axisLine:{show:false},
      splitLine:{lineStyle:{color:'#f3f4f6',type:'dashed'}}},
    series:[
      {name:'Besoin chauffage',type:'line',data:lds,smooth:.3,symbol:'none',
        lineStyle:{width:1.5,color:'#94a3b8'},
        areaStyle:{color:new echarts.graphic.LinearGradient(0,0,0,1,[{offset:0,color:'rgba(148,163,184,.12)'},{offset:1,color:'rgba(148,163,184,.01)'}])}},
      {name:'Capacite PAC',type:'line',data:pcs,smooth:.3,symbol:'none',
        lineStyle:{width:2.5,color:'#e8622a',type:'dashed'},
        areaStyle:{color:new echarts.graphic.LinearGradient(0,0,0,1,[{offset:0,color:'rgba(232,98,42,.1)'},{offset:1,color:'rgba(232,98,42,.01)'}])}}
    ]
  });
}
window.addEventListener('resize',()=>{if(S.chart)S.chart.resize()});

// ============================================================
// COMPETITORS
// ============================================================
function renderComp(sol){
  const cs=SizingEngine.compareWithCompetitors(sol,S.deperditionsKW,S.tbase,S.tWater);
  let h=`<div class="res-card anim"><div class="res-card-head"><span class="bar" style="background:#16a34a"></span>Comparaison concurrents<i class="ti ti-chevron-down chevron"></i></div>
    <div class="res-card-body"><div class="table-responsive"><table class="table table-striped table-hover mb-0" style="font-size:.82rem">
      <thead><tr><th>Marque</th><th>Modele</th><th class="text-center">Qty</th><th class="text-end">P.nom</th><th>Refrig.</th><th class="text-end">COP</th><th class="text-end">Part PAC</th><th class="text-end">Prix HT</th></tr></thead><tbody>`;
  cs.forEach(c=>{
    h+=`<tr${c.isAtlantic?' class="atlantic-row"':''}>
      <td><strong>${c.brand}</strong></td><td style="font-family:var(--mono)">${c.model}</td>
      <td class="text-center" style="font-family:var(--mono)">${c.nombre}</td>
      <td class="text-end" style="font-family:var(--mono)">${c.puissance_nom.toFixed(1)}</td>
      <td>${c.refrigerant}</td>
      <td class="text-end" style="font-family:var(--mono)">${c.cop_a7?c.cop_a7.toFixed(2):'\u2014'}</td>
      <td class="text-end" style="font-family:var(--mono)">${c.part_pac.toFixed(1)}%</td>
      <td class="text-end" style="font-family:var(--mono)">${c.prix_ht?fmtPrice(c.prix_ht):'\u2014'}</td></tr>`;
  });
  h+='</tbody></table></div></div></div>';
  document.getElementById('compArea').innerHTML=h;
}

// ============================================================
// ECS
// ============================================================
function calcECS(){
  const t=document.getElementById('ecsType').value;let r;
  if(t==='logements'){
    const p=document.querySelector('input[name="parc"]:checked').value,logs=[];
    document.querySelectorAll('#ecsGrid input[type="number"]').forEach(inp=>{const c=parseInt(inp.value)||0;if(c>0)logs.push({type:inp.dataset.type,count:c})});
    r=SizingEngine.calcECS({logements:logs,parc:p});
  }else{r=SizingEngine.calcECS({buildingType:t,units:parseInt(document.getElementById('ecsUnits').value)||50})}
  if(!r)return'<div class="results-empty"><p>Erreur calcul ECS.</p></div>';
  S.ecsResult=r;

  let h='<button class="btn-back-mobile" onclick="backToInputs()"><i class="ti ti-arrow-left"></i>Modifier les parametres</button>';
  h+='<div class="pdf-actions">';
  h+='<span class="pdf-actions-label">Actions</span>';
  h+='<button class="btn-pdf" onclick="generateECSPDF()"><i class="ti ti-file-type-pdf"></i>Export PDF ECS</button>';
  h+='<button class="btn-pdf teal" onclick="window.print()"><i class="ti ti-printer"></i>Imprimer</button>';
  h+='</div>';
  h+=`<div class="res-card anim"><div class="res-card-head"><span class="bar" style="background:#16a34a"></span>Resultats ECS</div>
    <div class="res-card-body"><table class="table table-striped mb-0"><tbody>`;
  if(r.ns!==undefined){
    h+=`<tr><td>Logements standards (Ns)</td><td class="hl">${r.ns}</td></tr>
      <tr><td>Volume journalier 60&deg;C</td><td>${r.vj} L/j</td></tr>
      <tr><td>V. pointe 10 min</td><td>${r.v10} L</td></tr>
      <tr><td>V. pointe 1h</td><td>${r.v1h} L</td></tr>
      <tr><td>Volume stockage min</td><td class="hl">${r.vStockage} L</td></tr>
      <tr><td>P. production (semi-accum.)</td><td class="hl">${r.pProduction} kW</td></tr>
      <tr><td>P. instantanee</td><td>${r.pInstantanee} kW</td></tr>`;
  }else{
    h+=`<tr><td>Type</td><td>${r.type}</td></tr>
      <tr><td>Nb ${r.unite}s</td><td>${r.nombre}</td></tr>
      <tr><td>Volume journalier 60&deg;C</td><td>${r.vj} L/j</td></tr>
      <tr><td>P. accumulation 8h</td><td class="hl">${r.pAccumulation} kW</td></tr>`;
  }
  h+=`<tr><td>T&deg; ECS</td><td>${r.tEcs}&deg;C</td></tr><tr><td>T&deg; eau froide</td><td>${r.tEf}&deg;C</td></tr></tbody></table></div></div>`;
  // Store for PDF
  S.ecsResultData=r;
  h+=`<div class="res-card card-danger anim"><div class="res-card-head text-danger"><i class="ti ti-alert-triangle me-2"></i>Prevention legionellose</div>
    <div class="res-card-body"><table class="table mb-0"><tbody>
      <tr><td>Stockage minimum</td><td>&ge; 55&deg;C</td></tr>
      <tr><td>Distribution</td><td>&ge; 50&deg;C partout</td></tr>
      <tr><td>Choc thermique</td><td>60&deg;C / 30 min / jour</td></tr>
      <tr><td>Robinet SdB</td><td>&le; 50&deg;C</td></tr></tbody></table></div></div>`;
  return h;
}
// ============================================================
// ECS PDF
// ============================================================
async function generateECSPDF(){
  const r=S.ecsResultData;if(!r)return alert('Calculez d\'abord l\'ECS.');
  if(!window.jspdf){try{await loadJsPDF()}catch(e){return alert('Impossible de charger jsPDF.')}}
  if(!window.jspdf){return alert('jsPDF non disponible.')}
  try{
  const {jsPDF}=window.jspdf;
  const doc=new jsPDF({unit:'mm',format:'a4'});
  const w=doc.internal.pageSize.getWidth();
  let y=pdfHeader(doc,'Dimensionnement ECS','Genere le '+new Date().toLocaleDateString('fr-FR'));

  y=pdfSection(doc,y,'DONNEES PROJET');
  y=pdfKeyValue(doc,y,'Departement',S.dept+' — '+deptName(S.dept));
  y=pdfKeyValue(doc,y,'Zone climatique',S.climat);
  y+=4;

  y=pdfSection(doc,y,'RESULTATS ECS');
  const rows=[];
  if(r.ns!==undefined){
    rows.push(['Logements standards (Ns)',String(r.ns)]);
    rows.push(['Volume journalier 60°C',r.vj+' L/j']);
    rows.push(['Volume pointe 10 min',r.v10+' L']);
    rows.push(['Volume pointe 1h',r.v1h+' L']);
    rows.push(['Volume stockage minimum',r.vStockage+' L']);
    rows.push(['Puissance production',r.pProduction+' kW']);
    rows.push(['Puissance instantanee',r.pInstantanee+' kW']);
  }else{
    rows.push(['Type',r.type]);
    rows.push(['Nb '+r.unite+'s',String(r.nombre)]);
    rows.push(['Volume journalier 60°C',r.vj+' L/j']);
    rows.push(['Puissance accumulation 8h',r.pAccumulation+' kW']);
  }
  rows.push(['T° ECS',r.tEcs+' °C']);
  rows.push(['T° eau froide',r.tEf+' °C']);

  doc.autoTable({
    startY:y,margin:{left:14,right:14},
    body:rows,
    bodyStyles:{fontSize:9,cellPadding:3},
    columnStyles:{0:{fontStyle:'bold',cellWidth:80},1:{halign:'right'}},
    alternateRowStyles:{fillColor:[248,250,252]}
  });
  y=doc.lastAutoTable.finalY+8;

  y=pdfSection(doc,y,'PREVENTION LEGIONELLOSE');
  doc.autoTable({
    startY:y,margin:{left:14,right:14},
    body:[
      ['Stockage minimum','>= 55 °C'],
      ['Distribution','>= 50 °C en tout point'],
      ['Choc thermique','60 °C / 30 min / jour'],
      ['Robinet SdB','<= 50 °C max'],
    ],
    bodyStyles:{fontSize:8.5,cellPadding:2.5},
    columnStyles:{0:{fontStyle:'bold',cellWidth:80},1:{halign:'right'}},
    alternateRowStyles:{fillColor:[255,245,245]}
  });

  pdfFooter(doc,1);
  openPdfPreview(doc,'ECS_Dimensionnement_'+S.dept+'.pdf');
  }catch(e){alert('Erreur generation PDF ECS: '+e.message);console.error('ECS PDF error:',e)}
}
</script>
</body>
</html>
